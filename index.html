<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B36 System v28 - Mobile First</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Alexandria:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Alexandria', sans-serif; }
        body { transition: background-color 0.3s, color 0.3s; }
        
        /* Calm Color Palette - Ø£Ù„ÙˆØ§Ù† Ù‡Ø§Ø¯ÙŠØ© */
        :root {
            --color-primary: #6B9AC4;      /* Ø£Ø²Ø±Ù‚ Ù‡Ø§Ø¯ÙŠ */
            --color-secondary: #8BA888;    /* Ø£Ø®Ø¶Ø± Ù†Ø§Ø¹Ù… */
            --color-accent: #D4A574;       /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­ */
            --color-warning: #E8A87C;      /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¯Ø§ÙØ¦ */
            --color-danger: #C97C7C;       /* Ø£Ø­Ù…Ø± Ù‡Ø§Ø¯ÙŠ */
            --color-success: #88B2AC;      /* Ø£Ø®Ø¶Ø± Ù…Ø§Ø¦ÙŠ */
            --color-info: #9DB4C0;         /* Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø²Ø±Ù‚ */
            --color-purple: #B8A4C9;       /* Ø¨Ù†ÙØ³Ø¬ÙŠ ÙØ§ØªØ­ */
        }
        
        /* Dark Mode */
        .dark body { background-color: #1a1f2e; color: #e2e8f0; }
        .dark .bg-white { background-color: #252b3b; }
        .dark .bg-slate-50 { background-color: #2a3142; }
        .dark .bg-slate-100 { background-color: #353d4f; }
        .dark .text-slate-800 { color: #e2e8f0; }
        .dark .text-slate-600 { color: #cbd5e1; }
        .dark .text-slate-500 { color: #94a3b8; }
        .dark .text-slate-400 { color: #64748b; }
        .dark .border-slate-100 { border-color: #353d4f; }
        .dark .border-slate-200 { border-color: #475569; }
        
        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(1.1); }
            20%, 40% { transform: scale(1.05); }
        }
        
        .animate-heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        .pulse-badge {
            animation: pulse-badge 2s infinite;
        }
        
        /* Hide number input spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        
        /* Image preview */
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 12px;
        }
        
        /* Status badges - Ø£Ù„ÙˆØ§Ù† Ù‡Ø§Ø¯ÙŠØ© */
        .status-new { background: linear-gradient(135deg, #C97C7C 0%, #B46D6D 100%); }
        .status-progress { background: linear-gradient(135deg, #E8A87C 0%, #D89A6D 100%); }
        .status-resolved { background: linear-gradient(135deg, #88B2AC 0%, #7AA39D 100%); }
        
        /* Priority badges - Ø£Ù„ÙˆØ§Ù† Ù†Ø§Ø¹Ù…Ø© */
        .priority-high { border-color: #C97C7C; background-color: #F5E8E8; color: #B46D6D; }
        .priority-medium { border-color: #E8A87C; background-color: #FBF3EC; color: #D89A6D; }
        .priority-low { border-color: #9DB4C0; background-color: #EEF3F5; color: #8AA5B1; }
        
        .dark .priority-high { background-color: #3d2828; color: #d89999; }
        .dark .priority-medium { background-color: #3d3228; color: #e8b98c; }
        .dark .priority-low { background-color: #28333d; color: #a8c5d1; }
        
        /* File upload area */
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .dark .upload-area:hover {
            background-color: #1e3a8a20;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #22c55e;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
    </style>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Alexandria', 'sans-serif'] } } }
        }
    </script>
</head>
<body class="antialiased bg-slate-50 dark:bg-slate-900">

<div id="toastContainer" class="fixed top-4 left-4 z-50 space-y-2"></div>

<!-- Login Screen -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-900 dark:to-slate-800">
    <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border-2 border-slate-200 dark:border-slate-700">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-black text-slate-800 dark:text-white mb-2">
                B36 System
            </h1>
            <span class="inline-block text-xs bg-gradient-to-r from-[#6B9AC4] to-[#88B2AC] text-white px-3 py-1 rounded-full font-bold">
                v28 Mobile First
            </span>
        </div>
        
        <form onsubmit="event.preventDefault(); login();" class="space-y-4 mb-6">
            <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="w-full p-3 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-center font-bold focus:border-[#6B9AC4] outline-none bg-white dark:bg-slate-700 text-slate-800 dark:text-white transition">
            <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-3 border-2 border-slate-300 dark:border-slate-600 rounded-xl text-center font-bold focus:border-[#6B9AC4] outline-none bg-white dark:bg-slate-700 text-slate-800 dark:text-white transition">
            <button type="submit" class="w-full bg-gradient-to-r from-[#6B9AC4] to-[#88B2AC] text-white p-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                Ø¯Ø®ÙˆÙ„
            </button>
        </form>
        
        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
            <p class="text-center text-xs text-black dark:text-slate-400 mb-2 font-bold">
                ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø©
            </p>
            <div class="text-center space-y-1">
                <p class="text-sm font-bold text-black dark:text-slate-300">Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ù…Ø§Ù„ÙƒÙŠ</p>
                <p class="text-sm font-bold text-black dark:text-slate-300">Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø£Ø­Ù…Ø¯ÙŠ</p>
                <p class="text-sm font-bold text-black dark:text-slate-300">Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø°Ø¨ÙŠØ§Ù†ÙŠ</p>
            </div>
            <div class="flex items-center justify-center gap-2 mt-3">
                <span class="text-black dark:text-slate-400 text-xs font-bold">Made with</span>
                <span class="text-red-500 text-lg animate-heartbeat">â¤ï¸</span>
                <span class="text-black dark:text-slate-400 text-xs font-bold">2026</span>
            </div>
        </div>
        
        <button onclick="systemReset()" class="mt-4 text-xs text-[#C97C7C] hover:text-[#B46D6D] w-full text-center font-bold">
            ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        </button>
    </div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white dark:bg-slate-800 border-l dark:border-slate-700 fixed h-full flex flex-col shadow-lg z-20">
        <div class="p-6 border-b dark:border-slate-700">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-black text-xl">B36 Admin</h2>
                    <span class="text-xs text-slate-400">v28 Mobile</span>
                </div>
                <button onclick="toggleDark()" class="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <i class="ph ph-moon text-xl" id="darkIcon"></i>
                </button>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="showView('dashboard')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-xl font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition">
                <i class="ph ph-squares-four text-xl text-[#6B9AC4]"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </button>
            <button onclick="showView('stats')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-xl font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition">
                <i class="ph ph-chart-bar text-xl text-[#88B2AC]"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </button>
            <button onclick="showView('logs')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-xl font-bold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition">
                <i class="ph ph-clock-clockwise text-xl text-purple-500"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
            </button>
            
            <div class="pt-4 mt-4 border-t dark:border-slate-700">
                <span class="text-[10px] text-slate-400 font-bold px-2 uppercase">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
                <button onclick="showView('halls')" id="btnHalls" class="w-full flex items-center gap-3 p-3 rounded-xl font-bold text-sm hover:bg-blue-50 dark:hover:bg-blue-900/30 text-[#6B9AC4] mt-2 transition">
                    <i class="ph ph-door text-xl"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª
                </button>
                <button onclick="showView('users')" id="btnUsers" class="w-full flex items-center gap-3 p-3 rounded-xl font-bold text-sm hover:bg-blue-50 dark:hover:bg-blue-900/30 text-[#6B9AC4] transition">
                    <i class="ph ph-users text-xl"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                </button>
                <button onclick="openModal('resetModal')" id="btnReset" class="w-full flex items-center gap-3 p-3 rounded-xl font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/30 text-[#C97C7C] transition">
                    <i class="ph ph-arrow-counter-clockwise text-xl"></i> ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                </button>
            </div>
        </nav>

        <div class="p-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
            <p class="text-[10px] text-center text-slate-400 mb-2">Developed by:</p>
            <p class="text-[9px] text-center text-slate-500 font-bold">A. Al-Malki | A. Al-Ahmadi | A. Al-Dhubiani</p>
            <button onclick="location.reload()" class="w-full mt-3 py-2 bg-red-100 dark:bg-red-900/30 text-[#C97C7C] rounded-lg text-xs font-bold hover:bg-red-200 transition">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 mr-64 p-8">
        <!-- KPIs -->
        <div class="flex flex-wrap bg-white dark:bg-slate-800 rounded-xl shadow-sm p-3 mb-8 gap-3 items-center justify-between border dark:border-slate-700">
            <div class="text-center px-4">
                <span class="block text-xs text-slate-400 mb-1">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰</span>
                <span id="kpiIndoor" class="text-2xl font-black text-[#6B9AC4]">0</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">ÙŠÙ†ØªØ¸Ø± Ø®Ø§Ø±Ø¬Ø§Ù‹</span>
                <span id="kpiOutdoor" class="text-2xl font-black text-[#E8A87C]">0</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">Ø§Ù„Ø·Ø§Ù‚Ø©</span>
                <span id="kpiCapacity" class="text-2xl font-black text-slate-600 dark:text-slate-300">0</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…</span>
                <span id="kpiServed" class="text-2xl font-black text-[#88B2AC]">0</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">Ø§Ù„Ø¥Ø´ØºØ§Ù„</span>
                <span id="kpiOccupancy" class="text-2xl font-black text-[#B8A4C9]">0%</span>
            </div>
        </div>

        <div id="contentArea"></div>
    </main>
</div>

<!-- Create Incident Modal -->
<div id="incidentModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-2xl modal-content my-8">
        <h3 class="font-bold text-xl mb-6 flex items-center gap-2">
            <i class="ph ph-warning-octagon text-[#C97C7C] text-2xl"></i>
            <span>Ø±ÙØ¹ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</span>
        </h3>
        
        <form id="incidentForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
                    <select id="incidentHall" required class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø© --</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</label>
                    <select id="incidentCategory" required class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                        <option value="CROWD">Ø§Ø²Ø¯Ø­Ø§Ù… Ø´Ø¯ÙŠØ¯</option>
                        <option value="MAINTENANCE">ØµÙŠØ§Ù†Ø© / Ù†Ø¸Ø§ÙØ©</option>
                        <option value="SECURITY">Ø£Ù…Ù† ÙˆØ³Ù„Ø§Ù…Ø©</option>
                        <option value="TECHNICAL">Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©</option>
                        <option value="OTHER">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                <div class="grid grid-cols-3 gap-3">
                    <label class="relative cursor-pointer">
                        <input type="radio" name="priority" value="HIGH" checked class="peer hidden">
                        <div class="p-4 border-2 rounded-xl text-center font-bold transition peer-checked:border-red-500 peer-checked:bg-red-50 dark:peer-checked:bg-red-900/20 border-slate-200 dark:border-slate-600">
                            <i class="ph ph-warning text-2xl text-[#C97C7C] block mb-1"></i>
                            <span class="text-sm">Ø¹Ø§Ø¬Ù„</span>
                        </div>
                    </label>
                    <label class="relative cursor-pointer">
                        <input type="radio" name="priority" value="MEDIUM" class="peer hidden">
                        <div class="p-4 border-2 rounded-xl text-center font-bold transition peer-checked:border-amber-500 peer-checked:bg-amber-50 dark:peer-checked:bg-amber-900/20 border-slate-200 dark:border-slate-600">
                            <i class="ph ph-clock text-2xl text-[#E8A87C] block mb-1"></i>
                            <span class="text-sm">Ù…ØªÙˆØ³Ø·</span>
                        </div>
                    </label>
                    <label class="relative cursor-pointer">
                        <input type="radio" name="priority" value="LOW" class="peer hidden">
                        <div class="p-4 border-2 rounded-xl text-center font-bold transition peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 border-slate-200 dark:border-slate-600">
                            <i class="ph ph-info text-2xl text-[#6B9AC4] block mb-1"></i>
                            <span class="text-sm">Ø¹Ø§Ø¯ÙŠ</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</label>
                <textarea id="incidentDescription" required rows="4" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition resize-none" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº Ù‡Ù†Ø§..."></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div class="upload-area rounded-xl p-6 cursor-pointer text-center" onclick="document.getElementById('incidentImage').click()">
                    <i class="ph ph-camera text-4xl text-slate-400 dark:text-slate-500 block mb-2"></i>
                    <p class="text-sm font-bold text-slate-500 dark:text-slate-400">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">PNG, JPG (Max 5MB)</p>
                </div>
                <input type="file" id="incidentImage" accept="image/*" class="hidden" onchange="previewImage(this)">
                <div id="imagePreviewContainer" class="hidden mt-3">
                    <img id="imagePreview" class="image-preview mx-auto">
                    <button type="button" onclick="removeImage()" class="mt-2 text-sm text-[#C97C7C] hover:text-red-700 font-bold">
                        <i class="ph ph-trash"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
                    </button>
                </div>
            </div>
        </form>
        
        <div class="flex gap-2 mt-6">
            <button onclick="closeModal('incidentModal')" class="flex-1 bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="submitIncident()" class="flex-1 bg-[#C97C7C] text-white p-3 rounded-xl font-bold hover:bg-[#B46D6D] transition flex items-center justify-center gap-2">
                <i class="ph ph-paper-plane-tilt text-xl"></i>
                <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</span>
            </button>
        </div>
    </div>
</div>

<!-- View Incident Modal -->
<div id="viewIncidentModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-3xl modal-content my-8">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="font-bold text-xl flex items-center gap-2">
                    <i class="ph ph-info text-[#6B9AC4] text-2xl"></i>
                    <span>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</span>
                </h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" id="incidentId"></p>
            </div>
            <button onclick="closeModal('viewIncidentModal')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>
        
        <div id="incidentDetailsContent" class="space-y-4"></div>
        
        <!-- Comments Section -->
        <div class="mt-6 pt-6 border-t dark:border-slate-700">
            <h4 class="font-bold mb-4 flex items-center gap-2">
                <i class="ph ph-chat-circle-dots text-[#6B9AC4]"></i>
                Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            </h4>
            
            <div id="commentsContainer" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div>
            
            <div class="flex gap-2">
                <input type="text" id="commentInput" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚..." class="flex-1 p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                <button onclick="addComment()" class="px-4 bg-[#6B9AC4] text-white rounded-xl font-bold hover:bg-[#5A89B3] transition">
                    <i class="ph ph-paper-plane-tilt"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Modal -->
<div id="resetModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-md modal-content">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <i class="ph ph-arrow-counter-clockwise text-[#6B9AC4]"></i> ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        </h3>
        <div class="space-y-3">
            <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition">
                <input type="checkbox" id="resetServed" class="w-4 h-4">
                <div>
                    <p class="font-bold text-sm">ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±</p>
                </div>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition">
                <input type="checkbox" id="resetOutdoor" class="w-4 h-4">
                <div>
                    <p class="font-bold text-sm">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">ØªØµÙÙŠØ± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</p>
                </div>
            </label>
            <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition">
                <input type="checkbox" id="resetRooms" class="w-4 h-4">
                <div>
                    <p class="font-bold text-sm">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">ØªØµÙÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</p>
                </div>
            </label>
        </div>
        <div class="flex gap-2 mt-4">
            <button onclick="closeModal('resetModal')" class="flex-1 bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="performReset()" class="flex-1 bg-[#6B9AC4] text-white p-3 rounded-xl font-bold hover:bg-[#5A89B3] transition">ØªØµÙÙŠØ±</button>
        </div>
    </div>
</div>

<!-- Hall Modal -->
<div id="hallModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-lg modal-content">
        <h3 class="font-bold text-xl mb-6 flex items-center gap-2">
            <i class="ph ph-door-open text-[#6B9AC4] text-2xl"></i>
            <span id="hallModalTitle">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
        </h3>
        <div class="space-y-4">
            <input type="hidden" id="hallId">
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
                <input type="text" id="hallName" required class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø§Ø¹Ø© 1">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰</label>
                    <input type="number" id="hallCapacity" required min="1" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition" placeholder="100">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ù†ÙˆØ¹</label>
                    <select id="hallType" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                        <option value="MAIN">Ù‚Ø§Ø¹Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</option>
                        <option value="WAITING">Ù…Ù†Ø·Ù‚Ø© Ø§Ù†ØªØ¸Ø§Ø±</option>
                        <option value="VIP">VIP</option>
                        <option value="OTHER">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                <select id="hallSupervisor" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                    <option value="">-- ØºÙŠØ± Ù…Ø­Ø¯Ø¯ --</option>
                </select>
            </div>
            <div class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-700 rounded-xl">
                <label class="toggle-switch">
                    <input type="checkbox" id="hallActive" checked>
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <p class="font-bold text-sm">Ø§Ù„Ù‚Ø§Ø¹Ø© Ù…ÙØ¹Ù‘Ù„Ø©</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¹Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
                </div>
            </div>
        </div>
        <div class="flex gap-2 mt-6">
            <button onclick="closeModal('hallModal')" class="flex-1 bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="saveHall()" class="flex-1 bg-[#6B9AC4] text-white p-3 rounded-xl font-bold hover:bg-[#5A89B3] transition flex items-center justify-center gap-2">
                <i class="ph ph-floppy-disk text-xl"></i><span>Ø­ÙØ¸</span>
            </button>
        </div>
    </div>
</div>

<!-- User Modal -->
<div id="userModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-lg modal-content">
        <h3 class="font-bold text-xl mb-6 flex items-center gap-2">
            <i class="ph ph-user-plus text-[#6B9AC4] text-2xl"></i>
            <span id="userModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</span>
        </h3>
        <div class="space-y-4">
            <input type="hidden" id="userId">
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="userName" required class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition" placeholder="username">
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="userPassword" required class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                <select id="userRole" onchange="toggleRoomSelect()" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                    <option value="ADMIN">Ù…Ø´Ø±Ù (Admin)</option>
                    <option value="ORGANIZER_INDOOR">Ù…Ù†Ø¸Ù… - Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰</option>
                    <option value="ORGANIZER_OUTDOOR">Ù…Ø³Ø¤ÙˆÙ„ - Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                    <option value="VIEWER">Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ (Viewer)</option>
                </select>
            </div>
            <div id="roomSelectContainer" class="hidden">
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†Ù‡Ø§</label>
                <select id="userRoom" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø© --</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="userFullName" class="w-full p-3 border-2 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl font-bold focus:border-blue-500 outline-none transition" placeholder="Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯">
            </div>
        </div>
        <div class="flex gap-2 mt-6">
            <button onclick="closeModal('userModal')" class="flex-1 bg-slate-100 dark:bg-slate-700 p-3 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="saveUser()" class="flex-1 bg-[#6B9AC4] text-white p-3 rounded-xl font-bold hover:bg-[#5A89B3] transition flex items-center justify-center gap-2">
                <i class="ph ph-floppy-disk text-xl"></i><span>Ø­ÙØ¸</span>
            </button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, onSnapshot, getDoc, getDocs, setDoc, updateDoc, increment, writeBatch, deleteDoc, serverTimestamp, query, orderBy, limit, addDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyAHzKx8e5cXP33zfSON_X1RC4Ek7JukaPg",
    authDomain: "b36-hall-mgmt.firebaseapp.com",
    projectId: "b36-hall-mgmt",
    storageBucket: "b36-hall-mgmt.firebasestorage.app",
    messagingSenderId: "972582807480",
    appId: "1:972582807480:web:bf5080de188b588325d14d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let rooms = [];
let logs = [];
let reports = [];
let users = [];
let globalStats = { served: 0, outdoor_queue: 0 };
let currentIncidentId = null;
let uploadedImageFile = null;

// Dark Mode
window.toggleDark = () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
};

if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark');
}

// Toast Notifications
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-amber-500',
        info: 'bg-blue-500'
    };
    
    const icons = {
        success: 'ph-check-circle',
        error: 'ph-x-circle',
        warning: 'ph-warning',
        info: 'ph-info'
    };
    
    toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
    toast.innerHTML = `<i class="ph ${icons[type]} text-xl"></i><span class="text-sm font-bold">${message}</span>`;
    
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// Activity Logger
async function logActivity(action, details, roomId = null) {
    try {
        await addDoc(collection(db, "activity_logs"), {
            user: currentUser.id,
            userRole: currentUser.role,
            action: action,
            details: details,
            roomId: roomId,
            roomName: roomId ? rooms.find(r => r.id === roomId)?.name : null,
            timestamp: serverTimestamp()
        });
    } catch (e) {
        console.error('Log error:', e);
    }
}

// Login
window.login = async () => {
    const u = document.getElementById('username').value.toLowerCase().trim();
    const p = document.getElementById('password').value;
    
    try {
        const d = await getDoc(doc(db, "users", u));
        if (d.exists() && d.data().pass === p) {
            currentUser = { id: u, ...d.data() };
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            if (currentUser.role !== 'ADMIN') {
                document.getElementById('btnHalls').classList.add('hidden');
                document.getElementById('btnUsers').classList.add('hidden');
                document.getElementById('btnReset').classList.add('hidden');
            }
            
            // Hide menu items for VIEWER
            if (currentUser.role === 'VIEWER') {
                // Hide dashboard, incidents, logs from sidebar
                const navBtns = document.querySelectorAll('nav button');
                navBtns.forEach(btn => {
                    if (btn.textContent.includes('Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') || 
                        btn.textContent.includes('Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª') || 
                        btn.textContent.includes('Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª')) {
                        btn.style.display = 'none';
                    }
                });
            }
            
            listen();
            
            // VIEWER goes directly to stats page
            if (currentUser.role === 'VIEWER') {
                showView('stats');
            } else {
                showView('dashboard');
            }
            
            showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.fullName || currentUser.id}`, 'success');
        } else {
            showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©', 'error');
        }
    } catch (e) {
        showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
};

// Firestore Listeners
function listen() {
    onSnapshot(collection(db, "rooms"), (s) => {
        rooms = [];
        s.forEach(d => rooms.push(d.data()));
        rooms.sort((a, b) => {
            const numA = parseInt(a.name.replace(/\D/g,'')) || 999;
            const numB = parseInt(b.name.replace(/\D/g,'')) || 999;
            return numA - numB;
        });
        updateKPIs();
        renderCurrentView();
    });
    
    onSnapshot(doc(db, "settings", "global_config"), (s) => {
        if (s.exists()) {
            const d = s.data();
            globalStats = { served: d.served_count || 0, outdoor_queue: d.outdoor_queue || 0 };
            updateKPIs();
        }
    });
    
    onSnapshot(query(collection(db, "reports"), orderBy("timestamp", "desc")), (s) => {
        reports = [];
        s.forEach(d => reports.push({ id: d.id, ...d.data() }));
        
        const badge = document.getElementById('incidentBadge');
        const newCount = reports.filter(r => r.status === 'NEW').length;
        if (newCount > 0) {
            badge.textContent = newCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
        
        renderCurrentView();
    });
    
    onSnapshot(collection(db, "users"), (s) => {
        users = [];
        s.forEach(d => users.push({ id: d.id, ...d.data() }));
        renderCurrentView();
    });
    
    onSnapshot(query(collection(db, "activity_logs"), orderBy("timestamp", "desc"), limit(200)), (s) => {
        logs = [];
        s.forEach(d => logs.push({ id: d.id, ...d.data() }));
        renderCurrentView();
    });
}

// Update KPIs
function updateKPIs() {
    const activeRooms = rooms.filter(r => r.active);
    const totalIndoor = activeRooms.reduce((a, b) => a + b.current, 0);
    const totalCap = activeRooms.reduce((a, b) => a + b.capacity, 0);
    const occupancyRate = totalCap > 0 ? Math.round((totalIndoor / totalCap) * 100) : 0;
    
    const kpiContainer = document.querySelector('main > div.flex.flex-wrap');
    if (!kpiContainer) return;
    
    if (currentUser.role === 'ADMIN') {
        kpiContainer.innerHTML = `
            <div class="text-center px-4">
                <span class="block text-xs text-slate-400 mb-1">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰</span>
                <span class="text-2xl font-black text-[#6B9AC4]">${totalIndoor}</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">ÙŠÙ†ØªØ¸Ø± Ø®Ø§Ø±Ø¬Ø§Ù‹</span>
                <span class="text-2xl font-black text-[#E8A87C]">${globalStats.outdoor_queue}</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">Ø§Ù„Ø·Ø§Ù‚Ø©</span>
                <span class="text-2xl font-black text-slate-600 dark:text-slate-300">${totalCap}</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…</span>
                <span class="text-2xl font-black text-[#88B2AC]">${globalStats.served}</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">Ø§Ù„Ø¥Ø´ØºØ§Ù„</span>
                <span class="text-2xl font-black text-[#B8A4C9]">${occupancyRate}%</span>
            </div>
        `;
    } else if (currentUser.role === 'ORGANIZER_INDOOR') {
        const myRoom = rooms.find(r => r.id === currentUser.roomId);
        if (myRoom) {
            const myOccupancy = myRoom.capacity > 0 ? Math.round((myRoom.current / myRoom.capacity) * 100) : 0;
            kpiContainer.innerHTML = `
                <div class="text-center px-4">
                    <span class="block text-xs text-slate-400 mb-1">Ø­Ø¶ÙˆØ± Ù‚Ø§Ø¹ØªÙŠ</span>
                    <span class="text-2xl font-black text-[#6B9AC4]">${myRoom.current}</span>
                </div>
                <div class="text-center px-4 border-r dark:border-slate-700">
                    <span class="block text-xs text-slate-400 mb-1">Ø³Ø¹Ø© Ù‚Ø§Ø¹ØªÙŠ</span>
                    <span class="text-2xl font-black text-slate-600 dark:text-slate-300">${myRoom.capacity}</span>
                </div>
                <div class="text-center px-4 border-r dark:border-slate-700">
                    <span class="block text-xs text-slate-400 mb-1">Ø¥Ø´ØºØ§Ù„ Ù‚Ø§Ø¹ØªÙŠ</span>
                    <span class="text-2xl font-black text-[#B8A4C9]">${myOccupancy}%</span>
                </div>
            `;
        }
    } else if (currentUser.role === 'ORGANIZER_OUTDOOR') {
        kpiContainer.innerHTML = `
            <div class="text-center px-4">
                <span class="block text-xs text-slate-400 mb-1">ÙŠÙ†ØªØ¸Ø± Ø®Ø§Ø±Ø¬Ø§Ù‹</span>
                <span class="text-2xl font-black text-[#E8A87C]">${globalStats.outdoor_queue}</span>
            </div>
        `;
    } else if (currentUser.role === 'VIEWER') {
        kpiContainer.innerHTML = `
            <div class="text-center px-4">
                <span class="block text-xs text-slate-400 mb-1">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰</span>
                <span class="text-2xl font-black text-[#6B9AC4]">${totalIndoor}</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">ÙŠÙ†ØªØ¸Ø± Ø®Ø§Ø±Ø¬Ø§Ù‹</span>
                <span class="text-2xl font-black text-[#E8A87C]">${globalStats.outdoor_queue}</span>
            </div>
            <div class="text-center px-4 border-r dark:border-slate-700">
                <span class="block text-xs text-slate-400 mb-1">ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…</span>
                <span class="text-2xl font-black text-[#88B2AC]">${globalStats.served}</span>
            </div>
        `;
    }
}

// View Management
let currentView = 'dashboard';

window.showView = (view) => {
    currentView = view;
    renderCurrentView();
};

function renderCurrentView() {
    if (currentView === 'dashboard') renderDashboard();
    else if (currentView === 'incidents') renderIncidents();
    else if (currentView === 'halls') renderHalls();
    else if (currentView === 'users') renderUsers();
    else if (currentView === 'stats') renderStats();
    else if (currentView === 'logs') renderLogs();
}

// Incidents Management Page
function renderIncidents() {
    const content = document.getElementById('contentArea');
    
    const newIncidents = reports.filter(r => r.status === 'NEW');
    const progressIncidents = reports.filter(r => r.status === 'PROGRESS');
    const resolvedIncidents = reports.filter(r => r.status === 'RESOLVED');
    
    const highPriority = reports.filter(r => r.priority === 'HIGH' && r.status !== 'RESOLVED').length;
    const avgResponseTime = '15 Ø¯Ù‚ÙŠÙ‚Ø©'; // Placeholder
    
    content.innerHTML = `
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2>
        <button onclick="openCreateIncidentModal()" class="px-4 py-2 bg-[#C97C7C] text-white rounded-xl font-bold hover:bg-[#B46D6D] transition flex items-center gap-2">
            <i class="ph ph-plus-circle text-xl"></i>
            Ø±ÙØ¹ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯
        </button>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-[#C97C7C] to-[#B46D6D] p-5 rounded-2xl text-white shadow-lg">
            <i class="ph ph-warning-circle text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${newIncidents.length}</h3>
            <p class="text-sm opacity-90">Ø¨Ù„Ø§ØºØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>
        <div class="bg-gradient-to-br from-[#E8A87C] to-[#D89A6D] p-5 rounded-2xl text-white shadow-lg">
            <i class="ph ph-hourglass text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${progressIncidents.length}</h3>
            <p class="text-sm opacity-90">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</p>
        </div>
        <div class="bg-gradient-to-br from-[#88B2AC] to-[#7AA39D] p-5 rounded-2xl text-white shadow-lg">
            <i class="ph ph-check-circle text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${resolvedIncidents.length}</h3>
            <p class="text-sm opacity-90">ØªÙ… Ø§Ù„Ø­Ù„</p>
        </div>
        <div class="bg-gradient-to-br from-[#B8A4C9] to-[#A895BA] p-5 rounded-2xl text-white shadow-lg">
            <i class="ph ph-fire text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${highPriority}</h3>
            <p class="text-sm opacity-90">Ø¹Ø§Ø¬Ù„Ø© Ù†Ø´Ø·Ø©</p>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 shadow-sm mb-6">
        <div class="flex flex-wrap gap-3">
            <select id="filterStatus" onchange="filterIncidents()" class="px-4 py-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg font-bold outline-none">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="NEW">Ø¬Ø¯ÙŠØ¯</option>
                <option value="PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                <option value="RESOLVED">ØªÙ… Ø§Ù„Ø­Ù„</option>
            </select>
            
            <select id="filterPriority" onchange="filterIncidents()" class="px-4 py-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg font-bold outline-none">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</option>
                <option value="HIGH">Ø¹Ø§Ø¬Ù„</option>
                <option value="MEDIUM">Ù…ØªÙˆØ³Ø·</option>
                <option value="LOW">Ø¹Ø§Ø¯ÙŠ</option>
            </select>
            
            <select id="filterCategory" onchange="filterIncidents()" class="px-4 py-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg font-bold outline-none">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="CROWD">Ø§Ø²Ø¯Ø­Ø§Ù…</option>
                <option value="MAINTENANCE">ØµÙŠØ§Ù†Ø©</option>
                <option value="SECURITY">Ø£Ù…Ù†</option>
                <option value="TECHNICAL">ØªÙ‚Ù†ÙŠ</option>
                <option value="OTHER">Ø£Ø®Ø±Ù‰</option>
            </select>
            
            <input type="text" id="filterSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterIncidents()" class="flex-1 px-4 py-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg font-bold outline-none min-w-[200px]">
            
            <button onclick="exportIncidents()" class="px-4 py-2 bg-[#88B2AC] text-white rounded-lg font-bold hover:bg-green-700 transition">
                <i class="ph ph-download"></i> ØªØµØ¯ÙŠØ±
            </button>
        </div>
    </div>
    
    <!-- Incidents Grid -->
    <div id="incidentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>
    `;
    
    displayIncidents(reports);
}

function displayIncidents(incidentsToShow) {
    const grid = document.getElementById('incidentsGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    if (incidentsToShow.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-20"><p class="text-2xl font-bold text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</p></div>';
        return;
    }
    
    incidentsToShow.forEach(incident => {
        const time = incident.timestamp ? new Date(incident.timestamp.seconds * 1000).toLocaleString('ar-SA', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'Ø§Ù„Ø¢Ù†';
        
        let statusClass = 'status-new';
        let statusText = 'Ø¬Ø¯ÙŠØ¯';
        let statusIcon = 'ph-warning-circle';
        
        if (incident.status === 'PROGRESS') {
            statusClass = 'status-progress';
            statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
            statusIcon = 'ph-hourglass';
        } else if (incident.status === 'RESOLVED') {
            statusClass = 'status-resolved';
            statusText = 'ØªÙ… Ø§Ù„Ø­Ù„';
            statusIcon = 'ph-check-circle';
        }
        
        let priorityClass = 'priority-low';
        let priorityText = 'Ø¹Ø§Ø¯ÙŠ';
        
        if (incident.priority === 'HIGH') {
            priorityClass = 'priority-high';
            priorityText = 'Ø¹Ø§Ø¬Ù„';
        } else if (incident.priority === 'MEDIUM') {
            priorityClass = 'priority-medium';
            priorityText = 'Ù…ØªÙˆØ³Ø·';
        }
        
        let categoryText = incident.category;
        if (incident.category === 'CROWD') categoryText = 'Ø§Ø²Ø¯Ø­Ø§Ù…';
        else if (incident.category === 'MAINTENANCE') categoryText = 'ØµÙŠØ§Ù†Ø©';
        else if (incident.category === 'SECURITY') categoryText = 'Ø£Ù…Ù†';
        else if (incident.category === 'TECHNICAL') categoryText = 'ØªÙ‚Ù†ÙŠ';
        else categoryText = 'Ø£Ø®Ø±Ù‰';
        
        const commentsCount = incident.comments ? incident.comments.length : 0;
        
        grid.innerHTML += `
        <div class="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 shadow-sm hover:shadow-md transition overflow-hidden cursor-pointer" onclick="viewIncident('${incident.id}')">
            <div class="${statusClass} p-3 text-white flex justify-between items-center">
                <span class="font-bold text-sm flex items-center gap-2">
                    <i class="ph ${statusIcon}"></i>
                    ${statusText}
                </span>
                <span class="text-xs opacity-90">${time}</span>
            </div>
            
            <div class="p-4">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-lg mb-1">${incident.roomName || 'Ù…Ù†Ø·Ù‚Ø© Ø¹Ø§Ù…Ø©'}</h3>
                        <span class="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded font-bold">${categoryText}</span>
                    </div>
                    <span class="text-xs font-bold px-2 py-1 rounded border-2 ${priorityClass}">
                        ${priorityText}
                    </span>
                </div>
                
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-3 line-clamp-2">${incident.desc}</p>
                
                ${incident.imageUrl ? `
                    <div class="mb-3">
                        <img src="${incident.imageUrl}" class="w-full h-32 object-cover rounded-lg">
                    </div>
                ` : ''}
                
                <div class="flex justify-between items-center pt-3 border-t dark:border-slate-700 text-xs">
                    <span class="text-slate-500 dark:text-slate-400">
                        <i class="ph ph-user-circle"></i> ${incident.reportedBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                    </span>
                    <span class="text-slate-500 dark:text-slate-400">
                        <i class="ph ph-chat-circle-dots"></i> ${commentsCount} ØªØ¹Ù„ÙŠÙ‚
                    </span>
                </div>
            </div>
        </div>
        `;
    });
}

window.filterIncidents = () => {
    const statusFilter = document.getElementById('filterStatus')?.value || '';
    const priorityFilter = document.getElementById('filterPriority')?.value || '';
    const categoryFilter = document.getElementById('filterCategory')?.value || '';
    const searchTerm = document.getElementById('filterSearch')?.value.toLowerCase() || '';
    
    let filtered = reports;
    
    if (statusFilter) {
        filtered = filtered.filter(r => r.status === statusFilter);
    }
    
    if (priorityFilter) {
        filtered = filtered.filter(r => r.priority === priorityFilter);
    }
    
    if (categoryFilter) {
        filtered = filtered.filter(r => r.category === categoryFilter);
    }
    
    if (searchTerm) {
        filtered = filtered.filter(r =>
            (r.roomName && r.roomName.toLowerCase().includes(searchTerm)) ||
            r.desc.toLowerCase().includes(searchTerm) ||
            (r.reportedBy && r.reportedBy.toLowerCase().includes(searchTerm))
        );
    }
    
    displayIncidents(filtered);
};

window.exportIncidents = () => {
    const csvContent = "data:text/csv;charset=utf-8," + "Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ù‚Ø§Ø¹Ø©,Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©,Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„ØªÙØ§ØµÙŠÙ„,Ø§Ù„Ù…Ø¨Ù„Øº\n" + reports.map(r => {
        const time = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString('ar-SA') : 'Ø§Ù„Ø¢Ù†';
        const status = r.status === 'NEW' ? 'Ø¬Ø¯ÙŠØ¯' : r.status === 'PROGRESS' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' : 'ØªÙ… Ø§Ù„Ø­Ù„';
        const priority = r.priority === 'HIGH' ? 'Ø¹Ø§Ø¬Ù„' : r.priority === 'MEDIUM' ? 'Ù…ØªÙˆØ³Ø·' : 'Ø¹Ø§Ø¯ÙŠ';
        return `"${time}","${r.roomName || '-'}","${r.category}","${priority}","${status}","${r.desc}","${r.reportedBy || '-'}"`;
    }).join("\n");
    
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `Incidents_${new Date().toISOString().split('T')[0]}.csv`);
    link.click();
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª', 'success');
};

// Create Incident Modal
window.openCreateIncidentModal = () => {
    document.getElementById('incidentHall').innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø© --</option>' + 
        rooms.filter(r => r.active).map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    
    document.getElementById('incidentCategory').value = 'CROWD';
    document.getElementById('incidentDescription').value = '';
    document.querySelector('input[name="priority"][value="HIGH"]').checked = true;
    
    uploadedImageFile = null;
    document.getElementById('imagePreviewContainer').classList.add('hidden');
    
    document.getElementById('incidentModal').classList.remove('hidden');
};

window.previewImage = (input) => {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 5MB', 'error');
            input.value = '';
            return;
        }
        
        uploadedImageFile = file;
        const reader = new FileReader();
        
        reader.onload = (e) => {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreviewContainer').classList.remove('hidden');
        };
        
        reader.readAsDataURL(file);
    }
};

window.removeImage = () => {
    uploadedImageFile = null;
    document.getElementById('incidentImage').value = '';
    document.getElementById('imagePreviewContainer').classList.add('hidden');
};

window.submitIncident = async () => {
    const hallId = document.getElementById('incidentHall').value;
    const category = document.getElementById('incidentCategory').value;
    const description = document.getElementById('incidentDescription').value.trim();
    const priority = document.querySelector('input[name="priority"]:checked').value;
    
    if (!hallId || !description) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    
    showToast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨Ù„Ø§Øº...', 'info');
    
    try {
        let imageUrl = null;
        
        if (uploadedImageFile) {
            const storageRef = ref(storage, `incidents/${Date.now()}_${uploadedImageFile.name}`);
            await uploadBytes(storageRef, uploadedImageFile);
            imageUrl = await getDownloadURL(storageRef);
        }
        
        const incidentData = {
            roomId: hallId,
            roomName: rooms.find(r => r.id === hallId)?.name,
            category: category,
            desc: description,
            priority: priority,
            status: 'NEW',
            reportedBy: currentUser.fullName || currentUser.id,
            reportedById: currentUser.id,
            imageUrl: imageUrl,
            comments: [],
            timestamp: serverTimestamp()
        };
        
        await addDoc(collection(db, "reports"), incidentData);
        await logActivity('INCIDENT_CREATE', `Ø±ÙØ¹ Ø¨Ù„Ø§Øº: ${category} - ${priority}`, hallId);
        
        closeModal('incidentModal');
        showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (e) {
        console.error('Error:', e);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø¨Ù„Ø§Øº', 'error');
    }
};

// View Incident Modal
window.viewIncident = async (incidentId) => {
    currentIncidentId = incidentId;
    const incident = reports.find(r => r.id === incidentId);
    if (!incident) return;
    
    const time = incident.timestamp ? new Date(incident.timestamp.seconds * 1000).toLocaleString('ar-SA', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }) : 'Ø§Ù„Ø¢Ù†';
    
    let statusClass = 'bg-red-100 text-[#C97C7C] dark:bg-red-900/30';
    let statusText = 'Ø¬Ø¯ÙŠØ¯';
    
    if (incident.status === 'PROGRESS') {
        statusClass = 'bg-amber-100 text-[#E8A87C] dark:bg-amber-900/30';
        statusText = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
    } else if (incident.status === 'RESOLVED') {
        statusClass = 'bg-green-100 text-[#88B2AC] dark:bg-green-900/30';
        statusText = 'ØªÙ… Ø§Ù„Ø­Ù„';
    }
    
    let priorityClass = 'priority-low';
    let priorityText = 'Ø¹Ø§Ø¯ÙŠ';
    
    if (incident.priority === 'HIGH') {
        priorityClass = 'priority-high';
        priorityText = 'Ø¹Ø§Ø¬Ù„';
    } else if (incident.priority === 'MEDIUM') {
        priorityClass = 'priority-medium';
        priorityText = 'Ù…ØªÙˆØ³Ø·';
    }
    
    let categoryText = incident.category;
    if (incident.category === 'CROWD') categoryText = 'Ø§Ø²Ø¯Ø­Ø§Ù… Ø´Ø¯ÙŠØ¯';
    else if (incident.category === 'MAINTENANCE') categoryText = 'ØµÙŠØ§Ù†Ø© / Ù†Ø¸Ø§ÙØ©';
    else if (incident.category === 'SECURITY') categoryText = 'Ø£Ù…Ù† ÙˆØ³Ù„Ø§Ù…Ø©';
    else if (incident.category === 'TECHNICAL') categoryText = 'Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©';
    else categoryText = 'Ø£Ø®Ø±Ù‰';
    
    document.getElementById('incidentId').innerText = `#${incidentId.substring(0, 8)}`;
    
    const canManage = currentUser.role === 'ADMIN';
    
    document.getElementById('incidentDetailsContent').innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            ${canManage ? `
                <select id="statusSelect" onchange="updateIncidentStatus('${incidentId}')" class="w-full mt-1 p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg font-bold outline-none">
                    <option value="NEW" ${incident.status === 'NEW' ? 'selected' : ''}>Ø¬Ø¯ÙŠØ¯</option>
                    <option value="PROGRESS" ${incident.status === 'PROGRESS' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                    <option value="RESOLVED" ${incident.status === 'RESOLVED' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø­Ù„</option>
                </select>
            ` : `
                <p class="mt-1"><span class="text-xs font-bold px-3 py-1 rounded ${statusClass}">${statusText}</span></p>
            `}
        </div>
        
        <div>
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
            <p class="mt-1"><span class="text-xs font-bold px-3 py-1 rounded border-2 ${priorityClass}">${priorityText}</span></p>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„Ù‚Ø§Ø¹Ø©</label>
            <p class="mt-1 font-bold">${incident.roomName || 'Ù…Ù†Ø·Ù‚Ø© Ø¹Ø§Ù…Ø©'}</p>
        </div>
        
        <div>
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</label>
            <p class="mt-1 font-bold">${categoryText}</p>
        </div>
    </div>
    
    <div class="mt-4">
        <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
        <p class="mt-1 text-sm leading-relaxed p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">${incident.desc}</p>
    </div>
    
    ${incident.imageUrl ? `
        <div class="mt-4">
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©</label>
            <img src="${incident.imageUrl}" class="mt-2 w-full rounded-lg shadow-md cursor-pointer" onclick="window.open('${incident.imageUrl}', '_blank')">
        </div>
    ` : ''}
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 pt-4 border-t dark:border-slate-700">
        <div>
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">Ø§Ù„Ù…Ø¨Ù„Ù‘Øº</label>
            <p class="mt-1 font-bold text-sm">${incident.reportedBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
        </div>
        
        <div>
            <label class="text-xs font-bold text-slate-500 dark:text-slate-400">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¨Ù„Ø§Øº</label>
            <p class="mt-1 font-bold text-sm">${time}</p>
        </div>
    </div>
    
    ${canManage ? `
        <div class="mt-4 pt-4 border-t dark:border-slate-700 flex gap-2">
            <button onclick="deleteIncident('${incidentId}')" class="flex-1 bg-[#C97C7C] text-white p-3 rounded-xl font-bold hover:bg-[#B46D6D] transition">
                <i class="ph ph-trash"></i> Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº
            </button>
        </div>
    ` : ''}
    `;
    
    // Load comments
    loadComments(incident);
    
    document.getElementById('viewIncidentModal').classList.remove('hidden');
};

function loadComments(incident) {
    const container = document.getElementById('commentsContainer');
    if (!incident.comments || incident.comments.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</p>';
        return;
    }
    
    container.innerHTML = incident.comments.map(comment => {
        const time = comment.timestamp ? new Date(comment.timestamp.seconds * 1000).toLocaleString('ar-SA', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'Ø§Ù„Ø¢Ù†';
        
        return `
        <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">
            <div class="flex justify-between items-start mb-1">
                <span class="font-bold text-sm">${comment.user}</span>
                <span class="text-xs text-slate-500 dark:text-slate-400">${time}</span>
            </div>
            <p class="text-sm">${comment.text}</p>
        </div>
        `;
    }).join('');
}

window.addComment = async () => {
    const commentText = document.getElementById('commentInput').value.trim();
    if (!commentText) {
        showToast('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚', 'warning');
        return;
    }
    
    const commentData = {
        user: currentUser.fullName || currentUser.id,
        userId: currentUser.id,
        text: commentText,
        timestamp: serverTimestamp()
    };
    
    await updateDoc(doc(db, "reports", currentIncidentId), {
        comments: arrayUnion(commentData)
    });
    
    document.getElementById('commentInput').value = '';
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 'success');
};

window.updateIncidentStatus = async (incidentId) => {
    const newStatus = document.getElementById('statusSelect').value;
    
    await updateDoc(doc(db, "reports", incidentId), {
        status: newStatus
    });
    
    await logActivity('INCIDENT_UPDATE', `ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº Ø¥Ù„Ù‰: ${newStatus}`, incidentId);
    
    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'success');
};

window.deleteIncident = async (incidentId) => {
    const result = await Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    
    if (!result.isConfirmed) return;
    
    await deleteDoc(doc(db, "reports", incidentId));
    await logActivity('INCIDENT_DELETE', 'Ø­Ø°Ù Ø¨Ù„Ø§Øº', incidentId);
    
    closeModal('viewIncidentModal');
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº', 'success');
};

// Dashboard (Simple)
function renderDashboard() {
    const content = document.getElementById('contentArea');
    const activeRooms = rooms.filter(r => r.active);
    
    let html = '';
    
    if (currentUser.role === 'ORGANIZER_OUTDOOR' || currentUser.role === 'ADMIN') {
        html += `
        <div class="bg-gradient-to-br from-[#E8A87C] to-[#D89A6D] p-6 rounded-2xl text-white shadow-lg mb-6 max-w-md">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <i class="ph ph-users text-2xl"></i> Ø§Ù„Ø³Ø§Ø­Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
            </h3>
            <div class="flex justify-between items-end mb-4">
                <span class="text-5xl font-black">${globalStats.outdoor_queue}</span>
                <span class="text-sm opacity-90">Ø²Ø§Ø¦Ø± ÙŠÙ†ØªØ¸Ø±</span>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="adjustOutdoor(-1)" class="flex-1 py-3 bg-white/20 hover:bg-white/30 rounded-xl font-bold transition">
                    <i class="ph ph-minus"></i> Ø®Ø±ÙˆØ¬
                </button>
                <input type="number" id="outdoorInput" value="${globalStats.outdoor_queue}" min="0" 
                    onchange="setOutdoorManual()" 
                    class="w-24 text-center py-3 border-2 border-white/30 bg-white/10 text-white rounded-xl font-black text-lg focus:border-white/50 outline-none">
                <button onclick="adjustOutdoor(1)" class="flex-1 py-3 bg-white hover:bg-white/90 text-[#E8A87C] rounded-xl font-bold transition">
                    <i class="ph ph-plus"></i> Ø¯Ø®ÙˆÙ„
                </button>
            </div>
        </div>`;
    }
    
    html += `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">`;
    
    activeRooms.forEach(r => {
        if ((currentUser.role === 'ORGANIZER_INDOOR' || currentUser.role === 'ORGANIZER') && currentUser.roomId !== r.id) return;
        if (currentUser.role === 'ORGANIZER_OUTDOOR') return;
        
        const isPaused = r.status === 'PAUSED';
        const full = r.current >= r.capacity;
        const ratio = Math.min((r.current / r.capacity) * 100, 100);
        
        let barColor = 'bg-blue-500';
        if (ratio > 80) barColor = 'bg-amber-500';
        if (full) barColor = 'bg-red-500';
        if (isPaused) barColor = 'bg-slate-400';
        
        html += `
        <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm transition hover:shadow-lg ${isPaused ? 'opacity-60 grayscale' : ''}">
            <div class="flex justify-between items-start mb-3">
                ${currentUser.role !== 'VIEWER' ? `
                    <button onclick="togglePause('${r.id}', '${r.status || 'OPEN'}')" 
                        class="px-3 py-1.5 rounded-lg text-xs font-bold transition ${isPaused ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-600'}">
                        <i class="ph ${isPaused ? 'ph-play' : 'ph-pause'}"></i> ${isPaused ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'}
                    </button>
                ` : '<div></div>'}
                ${currentUser.role !== 'VIEWER' && !isPaused ? `
                    <button onclick="quickReportFromDashboard('${r.id}')" class="text-[#C97C7C] hover:text-[#C97C7C]">
                        <i class="ph ph-warning-circle text-2xl"></i>
                    </button>
                ` : '<div></div>'}
            </div>
            
            <h3 class="font-bold text-lg mb-2">${r.name}</h3>
            
            <div class="flex justify-between items-end mb-3">
                <span class="text-5xl font-black">${r.current}</span>
                <span class="text-xs text-slate-400">Ø§Ù„Ø³Ø¹Ø©: ${r.capacity}</span>
            </div>
            
            <div class="w-full h-3 bg-slate-100 dark:bg-slate-700 rounded-full mb-5 overflow-hidden">
                <div class="h-full ${barColor} transition-all duration-500" style="width:${ratio}%"></div>
            </div>
            
            ${currentUser.role !== 'VIEWER' ? `
                <div class="flex gap-2 items-center">
                    <button onclick="adjustRoom('${r.id}', -1)" 
                        class="flex-1 py-3 border-2 border-slate-200 dark:border-slate-600 rounded-xl font-bold hover:bg-slate-50 transition">
                        <i class="ph ph-minus"></i>
                    </button>
                    <input type="number" id="room_${r.id}" value="${r.current}" min="0" max="${r.capacity}" 
                        onchange="setRoomManual('${r.id}')" 
                        class="w-20 text-center py-3 border-2 border-blue-200 rounded-xl font-black text-lg focus:border-blue-500 outline-none">
                    <button onclick="adjustRoom('${r.id}', 1)" 
                        class="flex-1 py-3 bg-[#6B9AC4] text-white rounded-xl font-bold hover:bg-[#5A89B3] transition ${full || isPaused ? 'opacity-50 cursor-not-allowed' : ''}" 
                        ${full || isPaused ? 'disabled' : ''}>
                        <i class="ph ph-plus"></i>
                    </button>
                </div>
            ` : ''}
        </div>`;
    });
    
    html += `</div>`;
    content.innerHTML = html;
}

window.quickReportFromDashboard = (roomId) => {
    openCreateIncidentModal();
    // Pre-select the room
    setTimeout(() => {
        document.getElementById('incidentHall').value = roomId;
    }, 100);
};

// Placeholder renders
function renderHalls() {
    const content = document.getElementById('contentArea');
    
    content.innerHTML = `
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</h2>
        <button onclick="openAddHallModal()" class="px-4 py-2 bg-[#6B9AC4] text-white rounded-xl font-bold hover:bg-[#5A89B3] transition flex items-center gap-2">
            <i class="ph ph-plus-circle text-xl"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-[#6B9AC4] to-[#5A89B3] p-5 rounded-2xl text-white">
            <i class="ph ph-door text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${rooms.length}</h3>
            <p class="text-sm opacity-90">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</p>
        </div>
        <div class="bg-gradient-to-br from-[#88B2AC] to-[#7AA39D] p-5 rounded-2xl text-white">
            <i class="ph ph-check-circle text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${rooms.filter(r => r.active).length}</h3>
            <p class="text-sm opacity-90">Ù‚Ø§Ø¹Ø§Øª Ù…ÙØ¹Ù‘Ù„Ø©</p>
        </div>
        <div class="bg-gradient-to-br from-[#E8A87C] to-[#D89A6D] p-5 rounded-2xl text-white">
            <i class="ph ph-x-circle text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${rooms.filter(r => !r.active).length}</h3>
            <p class="text-sm opacity-90">Ù‚Ø§Ø¹Ø§Øª Ù…Ø¹Ø·Ù‘Ù„Ø©</p>
        </div>
        <div class="bg-gradient-to-br from-[#B8A4C9] to-[#A895BA] p-5 rounded-2xl text-white">
            <i class="ph ph-users text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${rooms.reduce((a, b) => a + b.capacity, 0)}</h3>
            <p class="text-sm opacity-90">Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</p>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        ${rooms.map(r => {
            const supervisor = users.find(u => u.roomId === r.id);
            const ratio = r.capacity > 0 ? Math.round((r.current / r.capacity) * 100) : 0;
            return `
            <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 shadow-sm hover:shadow-md transition ${!r.active ? 'opacity-60' : ''}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-lg">${r.name}</h3>
                        <span class="text-xs px-2 py-1 rounded ${r.active ? 'bg-green-100 text-[#88B2AC] dark:bg-green-900/30' : 'bg-slate-100 text-slate-600 dark:bg-slate-700'}">
                            ${r.active ? 'âœ“ Ù…ÙØ¹Ù‘Ù„Ø©' : 'âœ— Ù…Ø¹Ø·Ù‘Ù„Ø©'}
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editHall('${r.id}')" class="p-2 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg transition" title="ØªØ¹Ø¯ÙŠÙ„">
                            <i class="ph ph-pencil-simple text-[#6B9AC4] dark:text-blue-400"></i>
                        </button>
                        <button onclick="deleteHall('${r.id}', '${r.name}')" class="p-2 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition" title="Ø­Ø°Ù">
                            <i class="ph ph-trash text-[#C97C7C] dark:text-red-400"></i>
                        </button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰</span>
                        <span class="font-bold">${r.capacity} Ø´Ø®Øµ</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 dark:text-slate-400">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                        <span class="font-bold">${r.current} Ø´Ø®Øµ</span>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500 dark:text-slate-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø´ØºØ§Ù„</span>
                            <span class="font-bold">${ratio}%</span>
                        </div>
                        <div class="w-full h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                            <div class="h-full ${ratio >= 100 ? 'bg-red-500' : ratio >= 80 ? 'bg-amber-500' : 'bg-green-500'} transition-all" style="width: ${Math.min(ratio, 100)}%"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm pt-2 border-t dark:border-slate-700">
                        <span class="text-slate-500 dark:text-slate-400">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</span>
                        <span class="font-bold">${supervisor ? supervisor.fullName || supervisor.id : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                </div>
            </div>
            `;
        }).join('')}
    </div>
    `;
}

window.openAddHallModal = () => {
    document.getElementById('hallModalTitle').innerText = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©';
    document.getElementById('hallId').value = '';
    document.getElementById('hallName').value = '';
    document.getElementById('hallCapacity').value = '100';
    document.getElementById('hallType').value = 'MAIN';
    document.getElementById('hallActive').checked = true;
    document.getElementById('hallSupervisor').value = '';
    const select = document.getElementById('hallSupervisor');
    select.innerHTML = '<option value="">-- ØºÙŠØ± Ù…Ø­Ø¯Ø¯ --</option>';
    users.filter(u => u.role === 'ORGANIZER_INDOOR').forEach(u => {
        select.innerHTML += `<option value="${u.id}">${u.fullName || u.id}</option>`;
    });
    document.getElementById('hallModal').classList.remove('hidden');
};

window.editHall = (hallId) => {
    const hall = rooms.find(r => r.id === hallId);
    if (!hall) return;
    document.getElementById('hallModalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø©';
    document.getElementById('hallId').value = hall.id;
    document.getElementById('hallName').value = hall.name;
    document.getElementById('hallCapacity').value = hall.capacity;
    document.getElementById('hallType').value = hall.type || 'MAIN';
    document.getElementById('hallActive').checked = hall.active;
    const select = document.getElementById('hallSupervisor');
    select.innerHTML = '<option value="">-- ØºÙŠØ± Ù…Ø­Ø¯Ø¯ --</option>';
    users.filter(u => u.role === 'ORGANIZER_INDOOR').forEach(u => {
        const isAssigned = u.roomId === hallId;
        select.innerHTML += `<option value="${u.id}" ${isAssigned ? 'selected' : ''}>${u.fullName || u.id}</option>`;
    });
    document.getElementById('hallModal').classList.remove('hidden');
};

window.saveHall = async () => {
    const hallId = document.getElementById('hallId').value;
    const hallName = document.getElementById('hallName').value.trim();
    const hallCapacity = parseInt(document.getElementById('hallCapacity').value);
    const hallType = document.getElementById('hallType').value;
    const hallActive = document.getElementById('hallActive').checked;
    const hallSupervisor = document.getElementById('hallSupervisor').value;
    if (!hallName || hallCapacity < 1) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'error');
        return;
    }
    const b = writeBatch(db);
    const newHallId = hallId || `hall_${Date.now()}`;
    const hallData = {
        id: newHallId,
        name: hallName,
        capacity: hallCapacity,
        type: hallType,
        active: hallActive,
        current: hallId ? rooms.find(r => r.id === hallId)?.current || 0 : 0,
        status: 'OPEN'
    };
    b.set(doc(db, "rooms", newHallId), hallData);
    const previousSupervisor = users.find(u => u.roomId === newHallId);
    if (previousSupervisor) {
        b.update(doc(db, "users", previousSupervisor.id), { roomId: null });
    }
    if (hallSupervisor) {
        b.update(doc(db, "users", hallSupervisor), { roomId: newHallId });
    }
    await b.commit();
    await logActivity(hallId ? 'HALL_EDIT' : 'HALL_ADD', `${hallId ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ù‚Ø§Ø¹Ø©: ${hallName}`);
    closeModal('hallModal');
    showToast(hallId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¹Ø©' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¹Ø©', 'success');
};

window.deleteHall = async (hallId, hallName) => {
    const result = await Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: `Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø© "${hallName}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!result.isConfirmed) return;
    const b = writeBatch(db);
    b.delete(doc(db, "rooms", hallId));
    const assignedUser = users.find(u => u.roomId === hallId);
    if (assignedUser) {
        b.update(doc(db, "users", assignedUser.id), { roomId: null });
    }
    await b.commit();
    await logActivity('HALL_DELETE', `Ø­Ø°Ù Ù‚Ø§Ø¹Ø©: ${hallName}`);
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø©', 'success');
};

function renderUsers() {
    const content = document.getElementById('contentArea');
    const adminCount = users.filter(u => u.role === 'ADMIN').length;
    const indoorCount = users.filter(u => u.role === 'ORGANIZER_INDOOR').length;
    const outdoorCount = users.filter(u => u.role === 'ORGANIZER_OUTDOOR').length;
    const viewerCount = users.filter(u => u.role === 'VIEWER').length;
    
    content.innerHTML = `
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
        <button onclick="openAddUserModal()" class="px-4 py-2 bg-[#6B9AC4] text-white rounded-xl font-bold hover:bg-[#5A89B3] transition flex items-center gap-2">
            <i class="ph ph-user-plus text-xl"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
        </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-[#B8A4C9] to-[#A895BA] p-5 rounded-2xl text-white">
            <i class="ph ph-crown text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${adminCount}</h3>
            <p class="text-sm opacity-90">Ù…Ø´Ø±ÙÙŠÙ†</p>
        </div>
        <div class="bg-gradient-to-br from-[#6B9AC4] to-[#5A89B3] p-5 rounded-2xl text-white">
            <i class="ph ph-user-gear text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${indoorCount}</h3>
            <p class="text-sm opacity-90">Ù…Ù†Ø¸Ù…ÙŠÙ† - Ø¯Ø§Ø®Ù„ÙŠ</p>
        </div>
        <div class="bg-gradient-to-br from-[#E8A87C] to-[#D89A6D] p-5 rounded-2xl text-white">
            <i class="ph ph-user-circle text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${outdoorCount}</h3>
            <p class="text-sm opacity-90">Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† - Ø®Ø§Ø±Ø¬ÙŠ</p>
        </div>
        <div class="bg-gradient-to-br from-slate-500 to-slate-600 p-5 rounded-2xl text-white">
            <i class="ph ph-monitor text-3xl mb-2 block opacity-80"></i>
            <h3 class="text-3xl font-black">${viewerCount}</h3>
            <p class="text-sm opacity-90">Ø´Ø§Ø´Ø§Øª Ø¹Ø±Ø¶</p>
        </div>
    </div>
    
    <div class="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 dark:bg-slate-900">
                    <tr class="text-right">
                        <th class="p-4 font-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th class="p-4 font-bold">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                        <th class="p-4 font-bold">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                        <th class="p-4 font-bold">Ø§Ù„Ù‚Ø§Ø¹Ø©</th>
                        <th class="p-4 font-bold">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody class="divide-y dark:divide-slate-700">
                    ${users.map(u => {
                        let roleText = '';
                        let roleColor = '';
                        if (u.role === 'ADMIN') { roleText = 'Ù…Ø´Ø±Ù'; roleColor = 'bg-purple-100 text-[#B8A4C9] dark:bg-purple-900/30'; }
                        else if (u.role === 'ORGANIZER_INDOOR') { roleText = 'Ù…Ù†Ø¸Ù… - Ø¯Ø§Ø®Ù„ÙŠ'; roleColor = 'bg-blue-100 text-[#6B9AC4] dark:bg-blue-900/30'; }
                        else if (u.role === 'ORGANIZER_OUTDOOR') { roleText = 'Ù…Ø³Ø¤ÙˆÙ„ - Ø®Ø§Ø±Ø¬ÙŠ'; roleColor = 'bg-orange-100 text-[#E8A87C] dark:bg-orange-900/30'; }
                        else if (u.role === 'VIEWER') { roleText = 'Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶'; roleColor = 'bg-slate-100 text-slate-600 dark:bg-slate-700'; }
                        const assignedRoom = rooms.find(r => r.id === u.roomId);
                        return `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                            <td class="p-4 font-bold">${u.id}</td>
                            <td class="p-4">${u.fullName || '-'}</td>
                            <td class="p-4">
                                <span class="text-xs font-bold px-2 py-1 rounded ${roleColor}">${roleText}</span>
                            </td>
                            <td class="p-4 text-sm">${assignedRoom ? assignedRoom.name : '-'}</td>
                            <td class="p-4">
                                <div class="flex gap-2">
                                    <button onclick="editUser('${u.id}')" class="p-2 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg transition" title="ØªØ¹Ø¯ÙŠÙ„">
                                        <i class="ph ph-pencil-simple text-[#6B9AC4] dark:text-blue-400"></i>
                                    </button>
                                    ${u.role !== 'ADMIN' ? `
                                        <button onclick="deleteUser('${u.id}')" class="p-2 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition" title="Ø­Ø°Ù">
                                            <i class="ph ph-trash text-[#C97C7C] dark:text-red-400"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>
    `;
}

window.openAddUserModal = () => {
    document.getElementById('userModalTitle').innerText = 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯';
    document.getElementById('userId').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userRole').value = 'ORGANIZER_INDOOR';
    document.getElementById('userFullName').value = '';
    document.getElementById('userRoom').value = '';
    toggleRoomSelect();
    document.getElementById('userModal').classList.remove('hidden');
};

window.editUser = async (userId) => {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    document.getElementById('userModalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù';
    document.getElementById('userId').value = user.id;
    document.getElementById('userName').value = user.id;
    document.getElementById('userName').disabled = true;
    document.getElementById('userPassword').value = user.pass;
    document.getElementById('userRole').value = user.role;
    document.getElementById('userFullName').value = user.fullName || '';
    document.getElementById('userRoom').value = user.roomId || '';
    toggleRoomSelect();
    document.getElementById('userModal').classList.remove('hidden');
};

window.toggleRoomSelect = () => {
    const role = document.getElementById('userRole').value;
    const container = document.getElementById('roomSelectContainer');
    const select = document.getElementById('userRoom');
    if (role === 'ORGANIZER_INDOOR') {
        container.classList.remove('hidden');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø© --</option>';
        rooms.filter(r => r.active).forEach(r => {
            select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
        });
    } else {
        container.classList.add('hidden');
        select.value = '';
    }
};

window.saveUser = async () => {
    const userId = document.getElementById('userId').value.trim();
    const userName = document.getElementById('userName').value.trim().toLowerCase();
    const userPassword = document.getElementById('userPassword').value;
    const userRole = document.getElementById('userRole').value;
    const userFullName = document.getElementById('userFullName').value.trim();
    const userRoom = document.getElementById('userRoom').value;
    if (!userName || !userPassword) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    if (userRole === 'ORGANIZER_INDOOR' && !userRoom) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¹Ø© Ù„Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ', 'error');
        return;
    }
    const userData = {
        pass: userPassword,
        role: userRole,
        fullName: userFullName || null,
        roomId: userRole === 'ORGANIZER_INDOOR' ? userRoom : null
    };
    await setDoc(doc(db, "users", userName), userData);
    await logActivity(userId ? 'USER_EDIT' : 'USER_ADD', `${userId ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ù…ÙˆØ¸Ù: ${userName}`);
    closeModal('userModal');
    showToast(userId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù', 'success');
    document.getElementById('userName').disabled = false;
};

window.deleteUser = async (userId) => {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    const result = await Swal.fire({
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
        text: `Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.fullName || userId}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!result.isConfirmed) return;
    await deleteDoc(doc(db, "users", userId));
    await logActivity('USER_DELETE', `Ø­Ø°Ù Ù…ÙˆØ¸Ù: ${userId}`);
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù', 'success');
};

function renderStats() {
    const content = document.getElementById('contentArea');
    const activeRooms = rooms.filter(r => r.active);
    const totalIndoor = activeRooms.reduce((a, b) => a + b.current, 0);
    const totalCap = activeRooms.reduce((a, b) => a + b.capacity, 0);
    const avgOccupancy = totalCap > 0 ? Math.round((totalIndoor / totalCap) * 100) : 0;
    const fullRooms = activeRooms.filter(r => r.current >= r.capacity).length;
    const totalMovement = globalStats.served + totalIndoor;
    const sortedByOccupancy = [...activeRooms].sort((a, b) => (b.current / b.capacity) - (a.current / a.capacity));
    const mostBusy = sortedByOccupancy[0];
    const leastBusy = sortedByOccupancy[sortedByOccupancy.length - 1];
    
    content.innerHTML = `
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
        <div class="flex gap-2">
            <button onclick="exportStatsCSV()" class="px-4 py-2 bg-[#88B2AC] text-white rounded-xl font-bold hover:bg-green-700 flex items-center gap-2">
                <i class="ph ph-file-csv"></i> CSV
            </button>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="bg-gradient-to-br from-[#6B9AC4] to-[#5A89B3] p-6 rounded-2xl text-white shadow-lg">
            <i class="ph ph-users-three text-3xl opacity-80 mb-3 block"></i>
            <h3 class="text-3xl font-black">${totalIndoor}</h3>
            <p class="text-sm opacity-90">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰</p>
        </div>
        <div class="bg-gradient-to-br from-[#E8A87C] to-[#D89A6D] p-6 rounded-2xl text-white shadow-lg">
            <i class="ph ph-queue text-3xl opacity-80 mb-3 block"></i>
            <h3 class="text-3xl font-black">${globalStats.outdoor_queue}</h3>
            <p class="text-sm opacity-90">ÙŠÙ†ØªØ¸Ø± Ø®Ø§Ø±Ø¬Ø§Ù‹</p>
        </div>
        <div class="bg-gradient-to-br from-[#88B2AC] to-[#7AA39D] p-6 rounded-2xl text-white shadow-lg">
            <i class="ph ph-check-circle text-3xl opacity-80 mb-3 block"></i>
            <h3 class="text-3xl font-black">${globalStats.served}</h3>
            <p class="text-sm opacity-90">ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…</p>
        </div>
        <div class="bg-gradient-to-br from-[#B8A4C9] to-[#A895BA] p-6 rounded-2xl text-white shadow-lg">
            <i class="ph ph-arrows-clockwise text-3xl opacity-80 mb-3 block"></i>
            <h3 class="text-3xl font-black">${totalMovement}</h3>
            <p class="text-sm opacity-90">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø±ÙƒØ©</p>
        </div>
        <div class="bg-gradient-to-br from-[#E8A87C] to-[#D89A6D] p-6 rounded-2xl text-white shadow-lg">
            <i class="ph ph-warning-octagon text-3xl opacity-80 mb-3 block"></i>
            <h3 class="text-3xl font-black">${fullRooms}</h3>
            <p class="text-sm opacity-90">Ù‚Ø§Ø¹Ø§Øª Ù…Ù…ØªÙ„Ø¦Ø©</p>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border dark:border-slate-700 shadow-sm">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-[#88B2AC]">
                <i class="ph ph-trophy text-2xl"></i> Ø£ÙƒØ«Ø± Ù‚Ø§Ø¹Ø© Ø§Ø²Ø¯Ø­Ø§Ù…Ø§Ù‹
            </h3>
            ${mostBusy ? `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-black mb-1">${mostBusy.name}</p>
                        <p class="text-sm text-slate-500">${mostBusy.current} / ${mostBusy.capacity} Ø²Ø§Ø¦Ø±</p>
                    </div>
                    <div class="text-4xl font-black text-[#88B2AC]">
                        ${Math.round((mostBusy.current / mostBusy.capacity) * 100)}%
                    </div>
                </div>
            ` : '<p class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'}
        </div>
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border dark:border-slate-700 shadow-sm">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-[#6B9AC4]">
                <i class="ph ph-clock text-2xl"></i> Ø£Ù‚Ù„ Ù‚Ø§Ø¹Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Ù‹
            </h3>
            ${leastBusy ? `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-black mb-1">${leastBusy.name}</p>
                        <p class="text-sm text-slate-500">${leastBusy.current} / ${leastBusy.capacity} Ø²Ø§Ø¦Ø±</p>
                    </div>
                    <div class="text-4xl font-black text-[#6B9AC4]">
                        ${Math.round((leastBusy.current / leastBusy.capacity) * 100)}%
                    </div>
                </div>
            ` : '<p class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'}
        </div>
    </div>
    
    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border dark:border-slate-700 shadow-sm">
        <h3 class="font-bold text-lg mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-50 dark:bg-slate-900">
                    <tr class="text-right">
                        <th class="p-3 font-bold">Ø§Ù„Ù‚Ø§Ø¹Ø©</th>
                        <th class="p-3 font-bold">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                        <th class="p-3 font-bold">Ø§Ù„Ø³Ø¹Ø©</th>
                        <th class="p-3 font-bold">Ø§Ù„Ø¥Ø´ØºØ§Ù„</th>
                        <th class="p-3 font-bold">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody class="divide-y dark:divide-slate-700">
                    ${activeRooms.map(r => {
                        const ratio = Math.round((r.current / r.capacity) * 100);
                        const status = r.status === 'PAUSED' ? 'Ù…ØºÙ„Ù‚' : (ratio >= 100 ? 'Ù…Ù…ØªÙ„Ø¦' : ratio >= 80 ? 'Ø´Ø¨Ù‡ Ù…Ù…ØªÙ„Ø¦' : 'Ù…ØªØ§Ø­');
                        const statusColor = r.status === 'PAUSED' ? 'bg-slate-100 text-slate-600' : (ratio >= 100 ? 'bg-red-100 text-[#C97C7C]' : ratio >= 80 ? 'bg-amber-100 text-[#E8A87C]' : 'bg-green-100 text-[#88B2AC]');
                        return `
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                            <td class="p-3 font-bold">${r.name}</td>
                            <td class="p-3">${r.current}</td>
                            <td class="p-3">${r.capacity}</td>
                            <td class="p-3">
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full ${ratio >= 100 ? 'bg-red-500' : ratio >= 80 ? 'bg-amber-500' : 'bg-green-500'}" style="width:${Math.min(ratio, 100)}%"></div>
                                    </div>
                                    <span class="text-xs font-bold">${ratio}%</span>
                                </div>
                            </td>
                            <td class="p-3">
                                <span class="text-xs font-bold px-2 py-1 rounded ${statusColor}">${status}</span>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>
    `;
}

window.exportStatsCSV = () => {
    const activeRooms = rooms.filter(r => r.active);
    const csvContent = "data:text/csv;charset=utf-8," + "Ø§Ù„Ù‚Ø§Ø¹Ø©,Ø§Ù„Ø­Ø¶ÙˆØ±,Ø§Ù„Ø³Ø¹Ø©,Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø´ØºØ§Ù„,Ø§Ù„Ø­Ø§Ù„Ø©\n" + activeRooms.map(r => {
        const ratio = Math.round((r.current / r.capacity) * 100);
        const status = r.status === 'PAUSED' ? 'Ù…ØºÙ„Ù‚' : (ratio >= 100 ? 'Ù…Ù…ØªÙ„Ø¦' : ratio >= 80 ? 'Ø´Ø¨Ù‡ Ù…Ù…ØªÙ„Ø¦' : 'Ù…ØªØ§Ø­');
        return `"${r.name}","${r.current}","${r.capacity}","${ratio}%","${status}"`;
    }).join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `B36_Stats_${new Date().toISOString().split('T')[0]}.csv`);
    link.click();
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'success');
};

function renderLogs() {
    const content = document.getElementById('contentArea');
    
    content.innerHTML = `
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
        <button onclick="exportLogs()" class="px-4 py-2 bg-[#88B2AC] text-white rounded-xl font-bold hover:bg-green-700 flex items-center gap-2">
            <i class="ph ph-download"></i> ØªØµØ¯ÙŠØ±
        </button>
    </div>
    
    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 mb-6">
        <div class="flex gap-3">
            <input type="text" id="logSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." onkeyup="filterLogs()" class="flex-1 px-4 py-2 border dark:border-slate-600 dark:bg-slate-700 rounded-lg">
            <select id="logFilter" onchange="filterLogs()" class="px-4 py-2 border dark:border-slate-600 dark:bg-slate-700 rounded-lg">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                <option value="ENTRY">Ø¯Ø®ÙˆÙ„</option>
                <option value="EXIT">Ø®Ø±ÙˆØ¬</option>
                <option value="MANUAL_SET">ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ</option>
                <option value="PAUSE">Ø¥ÙŠÙ‚Ø§Ù</option>
                <option value="RESUME">ØªÙØ¹ÙŠÙ„</option>
                <option value="INCIDENT_CREATE">Ø±ÙØ¹ Ø¨Ù„Ø§Øº</option>
                <option value="INCIDENT_UPDATE">ØªØ­Ø¯ÙŠØ« Ø¨Ù„Ø§Øº</option>
            </select>
        </div>
    </div>
    
    <div class="bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto max-h-[600px]">
            <table class="w-full text-sm">
                <thead class="bg-slate-50 dark:bg-slate-900 sticky top-0">
                    <tr class="text-right">
                        <th class="p-3 font-bold">Ø§Ù„ÙˆÙ‚Øª</th>
                        <th class="p-3 font-bold">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th class="p-3 font-bold">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                        <th class="p-3 font-bold">Ø§Ù„Ù‚Ø§Ø¹Ø©</th>
                        <th class="p-3 font-bold">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody" class="divide-y dark:divide-slate-700"></tbody>
            </table>
        </div>
    </div>
    `;
    
    displayLogs(logs);
}

function displayLogs(logsToShow) {
    const tbody = document.getElementById('logsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = logsToShow.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>' : '';
    
    logsToShow.forEach(log => {
        const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString('ar-SA') : 'Ø§Ù„Ø¢Ù†';
        let actionText = log.action;
        let actionColor = 'text-slate-600';
        
        if (log.action === 'ENTRY') { actionText = 'âœ… Ø¯Ø®ÙˆÙ„'; actionColor = 'text-[#88B2AC]'; }
        else if (log.action === 'EXIT') { actionText = 'ğŸšª Ø®Ø±ÙˆØ¬'; actionColor = 'text-[#6B9AC4]'; }
        else if (log.action === 'MANUAL_SET') { actionText = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ'; actionColor = 'text-[#B8A4C9]'; }
        else if (log.action === 'PAUSE') { actionText = 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù'; actionColor = 'text-[#E8A87C]'; }
        else if (log.action === 'RESUME') { actionText = 'â–¶ï¸ ØªÙØ¹ÙŠÙ„'; actionColor = 'text-[#88B2AC]'; }
        else if (log.action === 'INCIDENT_CREATE') { actionText = 'ğŸš¨ Ø±ÙØ¹ Ø¨Ù„Ø§Øº'; actionColor = 'text-[#C97C7C]'; }
        else if (log.action === 'INCIDENT_UPDATE') { actionText = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨Ù„Ø§Øº'; actionColor = 'text-[#E8A87C]'; }
        
        tbody.innerHTML += `
        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
            <td class="p-3 text-xs text-slate-500">${time}</td>
            <td class="p-3 font-bold">${log.user}</td>
            <td class="p-3 ${actionColor} font-bold">${actionText}</td>
            <td class="p-3">${log.roomName || '-'}</td>
            <td class="p-3 text-slate-600 dark:text-slate-400">${log.details}</td>
        </tr>
        `;
    });
}

window.filterLogs = () => {
    const searchTerm = document.getElementById('logSearch')?.value.toLowerCase() || '';
    const actionFilter = document.getElementById('logFilter')?.value || '';
    let filtered = logs;
    if (searchTerm) {
        filtered = filtered.filter(log => 
            log.user.toLowerCase().includes(searchTerm) ||
            (log.roomName && log.roomName.toLowerCase().includes(searchTerm)) ||
            log.details.toLowerCase().includes(searchTerm)
        );
    }
    if (actionFilter) {
        filtered = filtered.filter(log => log.action === actionFilter);
    }
    displayLogs(filtered);
};

window.exportLogs = () => {
    const csvContent = "data:text/csv;charset=utf-8," + "Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ù…ÙˆØ¸Ù,Ø§Ù„Ø¹Ù…Ù„ÙŠØ©,Ø§Ù„Ù‚Ø§Ø¹Ø©,Ø§Ù„ØªÙØ§ØµÙŠÙ„\n" + logs.map(log => {
        const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString('ar-SA') : 'Ø§Ù„Ø¢Ù†';
        return `"${time}","${log.user}","${log.action}","${log.roomName || '-'}","${log.details}"`;
    }).join("\n");
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `Activity_Log_${new Date().toISOString().split('T')[0]}.csv`);
    link.click();
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„', 'success');
};

// Actions (keep existing)
window.adjustOutdoor = async (dir) => {
    if (dir === -1 && globalStats.outdoor_queue <= 0) {
        showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø± ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'warning');
        return;
    }
    await updateDoc(doc(db, "settings", "global_config"), { outdoor_queue: increment(dir) });
    await logActivity(dir === 1 ? 'OUTDOOR_ADD' : 'OUTDOOR_REMOVE', dir === 1 ? 'Ø¥Ø¶Ø§ÙØ© Ø²Ø§Ø¦Ø± Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'Ø®ØµÙ… Ø²Ø§Ø¦Ø± Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
    showToast(dir === 1 ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : 'ØªÙ… Ø§Ù„Ø®ØµÙ…', 'success');
};

window.setOutdoorManual = async () => {
    const newVal = parseInt(document.getElementById('outdoorInput').value) || 0;
    if (newVal < 0) return;
    const oldVal = globalStats.outdoor_queue;
    await updateDoc(doc(db, "settings", "global_config"), { outdoor_queue: newVal });
    await logActivity('MANUAL_SET', `ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù† ${oldVal} Ø¥Ù„Ù‰ ${newVal}`);
    showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
};

window.adjustRoom = async (id, dir) => {
    const r = rooms.find(x => x.id === id);
    if (dir === 1) {
        if (r.current >= r.capacity) { showToast('Ø§Ù„Ù‚Ø§Ø¹Ø© Ù…Ù…ØªÙ„Ø¦Ø©', 'warning'); return; }
        if (globalStats.outdoor_queue <= 0) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø± ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'warning'); return; }
        const b = writeBatch(db);
        b.update(doc(db, "rooms", id), { current: increment(1) });
        b.update(doc(db, "settings", "global_config"), { outdoor_queue: increment(-1) });
        await b.commit();
        await logActivity('ENTRY', 'Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø±', id);
        showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯Ø®ÙˆÙ„', 'success');
    } else {
        if (r.current <= 0) return;
        const b = writeBatch(db);
        b.update(doc(db, "rooms", id), { current: increment(-1) });
        b.update(doc(db, "settings", "global_config"), { served_count: increment(1) });
        await b.commit();
        await logActivity('EXIT', 'Ø®Ø±ÙˆØ¬ Ø²Ø§Ø¦Ø±', id);
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬', 'success');
    }
};

window.setRoomManual = async (id) => {
    const newVal = parseInt(document.getElementById(`room_${id}`).value) || 0;
    const r = rooms.find(x => x.id === id);
    if (newVal < 0 || newVal > r.capacity) { showToast('Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error'); document.getElementById(`room_${id}`).value = r.current; return; }
    const diff = newVal - r.current;
    if (diff === 0) return;
    const b = writeBatch(db);
    if (diff > 0) {
        if (globalStats.outdoor_queue < diff) { showToast('Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØºÙŠØ± ÙƒØ§ÙÙŠ', 'error'); document.getElementById(`room_${id}`).value = r.current; return; }
        b.update(doc(db, "rooms", id), { current: newVal });
        b.update(doc(db, "settings", "global_config"), { outdoor_queue: increment(-diff) });
        await b.commit();
        await logActivity('MANUAL_SET', `ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ: ${r.name} Ù…Ù† ${r.current} Ø¥Ù„Ù‰ ${newVal} (+${diff} Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±)`, id);
        showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${diff} Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ`, 'success');
    } else {
        b.update(doc(db, "rooms", id), { current: newVal });
        b.update(doc(db, "settings", "global_config"), { served_count: increment(Math.abs(diff)) });
        await b.commit();
        await logActivity('MANUAL_SET', `ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ: ${r.name} Ù…Ù† ${r.current} Ø¥Ù„Ù‰ ${newVal} (${Math.abs(diff)} ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…)`, id);
        showToast(`ØªÙ… Ù†Ù‚Ù„ ${Math.abs(diff)} Ø¥Ù„Ù‰ "ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…"`, 'success');
    }
};

window.togglePause = async (id, currentStatus) => {
    const newStatus = currentStatus === 'PAUSED' ? 'OPEN' : 'PAUSED';
    await updateDoc(doc(db, "rooms", id), { status: newStatus });
    await logActivity(newStatus === 'PAUSED' ? 'PAUSE' : 'RESUME', newStatus === 'PAUSED' ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù‚Ø§Ø¹Ø©' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø©', id);
    showToast(newStatus === 'PAUSED' ? 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„', 'success');
};

window.performReset = async () => {
    const resetServed = document.getElementById('resetServed').checked;
    const resetOutdoor = document.getElementById('resetOutdoor').checked;
    const resetRooms = document.getElementById('resetRooms').checked;
    if (!resetServed && !resetOutdoor && !resetRooms) { showToast('Ø§Ø®ØªØ± Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning'); return; }
    if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ±ØŸ')) return;
    const b = writeBatch(db);
    let details = [];
    if (resetServed) { b.update(doc(db, "settings", "global_config"), { served_count: 0 }); details.push('ØªÙ…Øª Ø®Ø¯Ù…ØªÙ‡Ù…'); }
    if (resetOutdoor) { b.update(doc(db, "settings", "global_config"), { outdoor_queue: 0 }); details.push('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'); }
    if (resetRooms) { rooms.forEach(r => b.update(doc(db, "rooms", r.id), { current: 0 })); details.push('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø§Ø¹Ø§Øª'); }
    await b.commit();
    await logActivity('RESET', `ØªØµÙÙŠØ±: ${details.join(', ')}`);
    closeModal('resetModal');
    showToast('ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
};

window.systemReset = async () => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!')) return;
    const b = writeBatch(db);
    b.set(doc(db, "users", "admin"), { pass: "1234", role: "ADMIN", fullName: "Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…" });
    b.set(doc(db, "settings", "global_config"), { served_count: 0, outdoor_queue: 0 });
    for (let i = 1; i <= 20; i++) {
        b.set(doc(db, "rooms", `hall_${i}`), { id: `hall_${i}`, name: `Ù‚Ø§Ø¹Ø© ${i}`, type: i <= 10 ? 'MAIN' : 'WAITING', capacity: 100, current: 0, active: i <= 5, status: 'OPEN' });
    }
    await b.commit();
    alert('ØªÙ…Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­');
    location.reload();
};

// Modal Functions
window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
</script>

</body>
</html>

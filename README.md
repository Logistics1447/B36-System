# ๐ข B36 Hall Management System v32 - RBAC Complete

ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุชุฏูู ุงููุฑุดุญูู ูุน ูุธุงู RBAC ูุงูู ูุฏููู

---

## ๐ ุจููุฉ ุงููุดุฑูุน

```
b36-system-v32/
โโโ index.html          # ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ (ูุญุฏุซุฉ)
โโโ styles.css          # ุงูุชูุณููุงุช (ูุญุฏุซุฉ)
โโโ app.js              # ุงูููุฏ ุงูุฑุฆูุณู (2076 ุณุทุฑ - ูุธุงู ูุงูู)
โโโ README.md           # ูุฐุง ุงูููู
โโโ IMPLEMENTATION.md   # ุฏููู ุงูุชูููุฐ ุงูุชูุตููู
โโโ TESTS.md            # ุงุฎุชุจุงุฑุงุช ุงููุจูู
```

---

## ๐ ุงูุชุซุจูุช ุงูุณุฑูุน

### ุนูู Netlify:
1. ุงุณุญุจ ุงููุฌูุฏ ูุงููุงู ุฅูู https://app.netlify.com
2. ุงูุชุธุฑ Deploy
3. ุงูุชุญ ุงูุฑุงุจุท
4. ุงุถุบุท "๐ง ุชููุฆุฉ ุงููุธุงู" ูุฅูุดุงุก ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ

---

## ๐ฅ ุงูุฃุฏูุงุฑ ุงูุณุชุฉ (6 Roles)

| ุงูุฏูุฑ | ุงูุงุณู ุจุงูุฅูุฌููุฒู | ุงููุตู |
|------|------------------|-------|
| **ููุฒุฑ ุงููุฏูุฑ ุงูุนุงู** | ADMIN | ุตูุงุญูุงุช ูุงููุฉ ุนูู ูู ุดูุก |
| **ููุฒุฑ ุงูููุธู ุงูุฎุงุฑุฌู ูุดุฑู** | EXTERNAL_SUPERVISOR | ุฅุฏุงุฑุฉ ุงูุงูุชุธุงุฑ ุงูุฎุงุฑุฌู + ุฅูุดุงุก ุทูุจุงุช OutsideโWaiting |
| **ููุฒุฑ ุงูููุธู ุงูุฎุงุฑุฌู ุนุงุฏู** | EXTERNAL_REGULAR | ุฅุฏุฎุงู ุฃุนุฏุงุฏ ุงูููุชุธุฑูู ุฎุงุฑุฌุงู ููุท |
| **ููุฒุฑ ุงูููุธู ุงูุฏุงุฎูู ูุดุฑู ุงููุจูู** | INTERNAL_SUPERVISOR | ุฅูุดุงุก ุทูุจุงุช WaitingโInterview + ุฅุนุงุฏุฉ ุชูุฒูุน |
| **ููุฒุฑ ุงูููุธู ุงูุฏุงุฎูู ุนุงุฏู** | INTERNAL_REGULAR | ูุจูู/ุฑูุถ + ูุตุงุฏูุฉ ุทูุจุงุช ูุงุนุชู |
| **ููุฒุฑ ุงูุนุฑุถ** | VIEWER | ุนุฑุถ Dashboard ููุท |

### ููุงุญุธุฉ ูููุฉ: 
**ููุธู ุงููุณุงุฑ** ููุณ ุฏูุฑุงู ูููุตูุงู - ูู **INTERNAL_REGULAR** ูุน:
```javascript
isPathOrganizer: true
```

---

## ๐ ุงูุญุณุงุจุงุช ุงูุชุฌุฑูุจูุฉ

ุจุนุฏ ุงูุถุบุท ุนูู "๐ง ุชููุฆุฉ ุงููุธุงู":

| ุงููุณุชุฎุฏู | ุงูุจุงุณูุฑุฏ | ุงูุฏูุฑ | ููุงุญุธุงุช |
|----------|---------|-------|---------|
| `admin` | `1234` | ููุฒุฑ ุงููุฏูุฑ ุงูุนุงู | ุตูุงุญูุงุช ูุงููุฉ |
| `external_supervisor` | `1234` | ููุฒุฑ ุงูููุธู ุงูุฎุงุฑุฌู ูุดุฑู | ุฅูุดุงุก ุทูุจุงุช OutsideโWaiting |
| `external_regular` | `1234` | ููุฒุฑ ุงูููุธู ุงูุฎุงุฑุฌู ุนุงุฏู | ุฅุฏุฎุงู ุฃุนุฏุงุฏ ููุท |
| `internal_supervisor` | `1234` | ููุฒุฑ ุงูููุธู ุงูุฏุงุฎูู ูุดุฑู ุงููุจูู | ุฅูุดุงุก ุทูุจุงุช WaitingโInterview |
| `internal_regular_1` | `1234` | ููุฒุฑ ุงูููุธู ุงูุฏุงุฎูู ุนุงุฏู | ูุนูู ููุงุนุฉ 1 |
| `internal_regular_2` | `1234` | ููุธู ูุณุงุฑ | ูุนูู ููุงุนุฉ 3 + isPathOrganizer = true |
| `viewer` | `1234` | ููุฒุฑ ุงูุนุฑุถ | ุนุฑุถ ููุท |

---

## โจ ุงูููุฒุงุช ุงููุงููุฉ ุงููููุฐุฉ

### โ ูุธุงู RBAC ุงููุชูุฏู
- 6 ุฃุฏูุงุฑ ูุญุฏุฏุฉ ุจุฏูุฉ
- ูุตูููุฉ ุตูุงุญูุงุช ููุตูุฉ (18+ ุตูุงุญูุฉ)
- ุชุญูู ุนูู ูุณุชูู ุงูููุฏ
- ููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ

### โ State Machine ููุทูุจุงุช
```
Draft โ Pending โ Accepted/Rejected
         โ
    InTransit (ุงุฎุชูุงุฑู)
         โ
     Arrived โ Closed
```

### โ ูุธุงู ุงููุตุงุฏูุฉ (Confirmation System)
- ุฅุฏุฎุงู ุงูุนุฏุฏ ุงููุนูู ุงููุณุชูู
- ุญุณุงุจ ุงููุฑู ุชููุงุฆูุงู
- ุชุนููู ุฅูุฒุงูู ุนูุฏ ูุฌูุฏ ูุฑู
- ุชุตููู: ูุทุงุจู / ูุงูุต / ุฒูุงุฏุฉ
- ุชุณุฌูู ุงูููููุฏูู (missing_count)

### โ Workflows ุงูุซูุงุซุฉ

#### 1๏ธโฃ Outside โ Waiting Halls
```
1. External Supervisor ููุดุฆ ุงูุทูุจ
2. Internal Regular (ูุณุคูู ุงููุงุนุฉ) ููุจู/ูุฑูุถ
3. ุนูุฏ ุงููุตูู: ูุตุงุฏู ุนูู ุงูุนุฏุฏ
4. ุงููุธุงู ูุญุฏุซ: outdoor_queue + waiting_hall
```

#### 2๏ธโฃ Waiting โ Interview (via Path Organizer)
```
1. Internal Supervisor ููุดุฆ ุงูุทูุจ + ูุนูู ููุธู ุงููุณุงุฑ
2. ููุธู ุงููุณุงุฑ ูุจุฏุฃ ุงูููู (InTransit)
3. ูุณุคูู ูุงุนุฉ ุงูููุงุจูุงุช ูุตุงุฏู
4. ุงููุธุงู ูุญุฏุซ ุงููุงุนุงุช
```

#### 3๏ธโฃ Interview โ Interview (Rebalancing)
```
1. Internal Supervisor ููุดุฆ ุทูุจ ุฅุนุงุฏุฉ ุชูุฒูุน
2. ูุณุคูู ุงููุงุนุฉ ุงููุณุชูุฏูุฉ ููุจู
3. ุงููุตุงุฏูุฉ ูุงูุชูููุฐ
```

### โ Dashboard & KPIs
- ููุชุธุฑูู ุฎุงุฑุฌุงู
- ูู ูุงุนุงุช ุงูุงูุชุธุงุฑ
- ูู ูุงุนุงุช ุงูููุงุจูุงุช
- **ููููุฏูู/ุชุงุฆููู** (ุฌุฏูุฏ!)
- ุชูุช ุฎุฏูุชูู

### โ ุฅุฏุงุฑุฉ ุงููุงุนุงุช
- ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู
- ุชูุนูู/ุชุนุทูู
- ุนุฑุถ ูุณุจุฉ ุงูุฅุดุบุงู

### โ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู (Admin Only)
- ุฅุถุงูุฉ/ุชุนุฏูู ุงููุณุชุฎุฏููู
- ุชุนููู ุงูุฃุฏูุงุฑ
- ุชุนููู ุงููุงุนุงุช
- ุชุญุฏูุฏ ููุธูู ุงููุณุงุฑ (isPathOrganizer flag)

### โ Audit Log (Admin Only)
- ุณุฌู ูุงูู ููู ุงูุนูููุงุช
- ููุชุฑุฉ ุญุณุจ ุงูุชุงุฑูุฎ/ุงููุณุชุฎุฏู/ุงูููุน
- ูุญุชูู ุนูู: ูุจู/ุจุนุฏ/ุงูุณุจุจ

### โ ุงูููู ุงูุดุฎุตู
- ุนุฑุถ ุงููุนูููุงุช ุงูุดุฎุตูุฉ
- ุชุนุฏูู ุงูุงุณู ุงููุงูู
- ุชุบููุฑ ูููุฉ ุงููุฑูุฑ

---

## ๐ ูุตูููุฉ ุงูุตูุงุญูุงุช ุงููุงููุฉ

### Outside Count Management
| ุงูุตูุงุญูุฉ | ADMIN | External Supervisor | External Regular | Internal Supervisor | Internal Regular | Viewer |
|----------|:-----:|:------------------:|:---------------:|:------------------:|:---------------:|:------:|
| ุฅุถุงูุฉ/ุชุนุฏูู | โ | โ | โ | โ | โ | โ |
| ุนุฑุถ | โ | โ | โ | โ | โ | โ |

### Transfer Requests - Outside to Waiting
| ุงูุตูุงุญูุฉ | ADMIN | External Supervisor | External Regular | Internal Supervisor | Internal Regular | Viewer |
|----------|:-----:|:------------------:|:---------------:|:------------------:|:---------------:|:------:|
| ุฅูุดุงุก ุทูุจ | โ | โ | โ | โ | โ | โ |
| ูุจูู/ุฑูุถ | โ | โ | โ | โ (override) | โ (ูุงุนุชู ููุท) | โ |
| ูุตุงุฏูุฉ ุงููุตูู | โ | โ | โ | โ | โ (ูุงุนุชู ููุท) | โ |

### Transfer Requests - Waiting to Interview
| ุงูุตูุงุญูุฉ | ADMIN | External Supervisor | External Regular | Internal Supervisor | Internal Regular | Viewer |
|----------|:-----:|:------------------:|:---------------:|:------------------:|:---------------:|:------:|
| ุฅูุดุงุก ุทูุจ | โ | โ | โ | โ | โ | โ |
| ุชุนููู ููุธู ูุณุงุฑ | โ | โ | โ | โ | โ | โ |
| ุจุฏุก ุงูููู (InTransit) | โ | โ | โ | โ | โ (ุฅุฐุง ููุธู ูุณุงุฑ) | โ |
| ูุตุงุฏูุฉ ุงููุตูู | โ | โ | โ | โ | โ (ูุงุนุชู ููุท) | โ |

### Management
| ุงูุตูุงุญูุฉ | ADMIN | ุงูุจุงูู |
|----------|:-----:|:------:|
| ุฅุฏุงุฑุฉ ุงููุงุนุงุช | โ | โ |
| ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู | โ | โ |
| ุชุนููู ุงูุฃุฏูุงุฑ | โ | โ |

### Analytics & Logs
| ุงูุตูุงุญูุฉ | ADMIN | Viewer | ุงูุจุงูู |
|----------|:-----:|:------:|:------:|
| ุนุฑุถ Dashboard | โ | โ | โ |
| ุนุฑุถ Audit Log | โ | โ | โ |

---

## ๐ฏ ููููุฉ ุงูุงุณุชุฎุฏุงู

### Scenario 1: ููู ูู ุงูุฎุงุฑุฌ ุฅูู ูุงุนุฉ ุงูุชุธุงุฑ

1. **External Supervisor** ูุณุฌู ุฏุฎูู
2. ูุฐูุจ ูู "ุทูุจุงุช ุงูููู"
3. "ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ"
4. ูุฎุชุงุฑ ุงููุงุนุฉ ุงููุณุชูุฏูุฉ + ุงูุนุฏุฏ
5. ุงูุทูุจ ูุตุจุญ: **Pending**

6. **Internal Regular** (ูุณุคูู ุงููุงุนุฉ) ูุณุฌู ุฏุฎูู
7. ูุฑู ุงูุทูุจ ูู ูุงุฆูุชู
8. ูุถุบุท **"ูุจูู"** โ ุงูุทูุจ ูุตุจุญ: **Accepted**

9. ุนูุฏ ูุตูู ุงููุฑุดุญูู ูุนููุงู:
10. ูุถุบุท **"ูุตุงุฏูุฉ ุงููุตูู"**
11. ูุฏุฎู ุงูุนุฏุฏ ุงููุนูู (ูุซูุงู: 48 ูู 50)
12. ุงููุธุงู ูุญุณุจ ุงููุฑู: **-2** (ูุงูุต)
13. ูุฏุฎู ุชุนููู: "ุดุฎุตุงู ูู ูุตูุง"
14. ูุถุบุท **"ุชุฃููุฏ ุงููุตุงุฏูุฉ"**

15. ุงููุธุงู ูุญุฏุซ:
    - outdoor_queue -= 48
    - waiting_hall += 48
    - missing_count += 2
    - ุงูุทูุจ ูุตุจุญ: **Arrived โ Closed**

---

### Scenario 2: ููู ูู ุงูุชุธุงุฑ ุฅูู ููุงุจูุงุช (ุนุจุฑ ููุธู ุงููุณุงุฑ)

1. **Internal Supervisor** ููุดุฆ ุทูุจ
2. ูุฎุชุงุฑ: ูุงุนุฉ ุงูุชุธุงุฑ โ ูุงุนุฉ ููุงุจูุงุช
3. ูุฎุชุงุฑ ููุธู ุงููุณุงุฑ ูู ุงููุงุฆูุฉ
4. ุงูุทูุจ ูุตุจุญ: **Pending**

5. **ููุธู ุงููุณุงุฑ** (Internal Regular ูุน isPathOrganizer=true)
6. ูุฑู ุงูุทูุจ ุงููุฎุตุต ูู
7. ูุถุบุท **"ุจุฏุก ุงูููู"**
8. ุงูุทูุจ ูุตุจุญ: **InTransit**
9. waiting_hall -= ุงูุนุฏุฏ (ููุฑุงู)

10. ุนูุฏ ุงููุตูู ููุงุนุฉ ุงูููุงุจูุงุช:
11. **ูุณุคูู ูุงุนุฉ ุงูููุงุจูุงุช** ูุถุบุท "ูุตุงุฏูุฉ"
12. ูุฏุฎู ุงูุนุฏุฏ ุงููุนูู
13. interview_hall += ุงูุนุฏุฏ
14. ุงูุทูุจ ูุตุจุญ: **Arrived โ Closed**

---

## ๐ ุงูุฃูุงู

### 1. Validation ุนูู ูุณุชูู ุงูููุฏ
```javascript
// ุงูุชุญูู ูู ุงูุตูุงุญูุฉ
if (!hasPermission(PERMISSIONS.ACCEPT_REQUEST)) {
    showToast('ููุณ ูุฏูู ุตูุงุญูุฉ', 'error');
    return;
}

// ุงูุชุญูู ูู ุชุนููู ุงููุงุนุฉ
if (currentUser.assignedHallId !== request.toId) {
    showToast('ููููู ูุจูู ุทูุจุงุช ูุงุนุชู ููุท', 'error');
    return;
}

// ุงูุชุญูู ูู State Machine
validateStateTransition(currentState, newState);
```

### 2. Audit Logging
ูู ุนูููุฉ ุชูุณุฌู ูุน:
- userId, userRole, userName
- action, details
- entityType, entityId
- before, after
- reason (ุฅู ูุฌุฏ)
- timestamp

### 3. State Machine Enforcement
ูุง ูููู ุงูุงูุชูุงู ุฅูุง ููุญุงูุงุช ุงูุตุญูุญุฉ:
```javascript
Pending โ Accepted โ
Pending โ Closed โ (ููููุน)
Accepted โ Rejected โ (ููููุน)
```

---

## ๐ ููุงุญุธุงุช ุชูููุฉ

### Firebase Collections:
```
- users: {id, role, fullName, pass, assignedHallId, isPathOrganizer, active}
- halls: {name, type, capacity, current, active}
- transfer_requests: {type, fromType, fromId, toType, toId, requestedCount, 
                       actualCount, status, assignedPathOrganizer, confirmationId, ...}
- confirmations: {requestId, requestedCount, actualCount, difference, 
                  differenceType, comment, confirmedBy, confirmedAt}
- audit_logs: {userId, userRole, action, details, entityType, entityId, 
               before, after, reason, timestamp}
- settings/global_config: {served_count, outdoor_queue, missing_count}
```

### Real-time Updates:
- ุงุณุชุฎุฏุงู `onSnapshot` ููู ุงูุชุญุฏูุซุงุช
- UI ูุชุญุฏุซ ููุฑุงู ุนูุฏ ุชุบููุฑ ุงูุจูุงูุงุช

### Error Handling:
- ูู ุฏุงูุฉ ูุญููุฉ ุจู `try-catch`
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูููุณุชุฎุฏู

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ูุธูุฑ ุงูุทูุจ ูู ูุงุฆูุชู
**ุงูุญู:** ุชุฃูุฏ ูู:
1. ุฃูู ูุณุคูู ุนู ุงููุงุนุฉ ุงููุณุชูุฏูุฉ (assignedHallId)
2. ุฃู ุฃูู External Supervisor (ููุทูุจุงุช ุงูุชู ุฃูุดุฃุชูุง)
3. ุฃู ุฃูู Admin/Internal Supervisor (ูุฑูู ูู ุงูุทูุจุงุช)

### ุงููุดููุฉ: ูุง ุฃุณุชุทูุน ุจุฏุก ุงูููู
**ุงูุญู:** ุชุฃูุฏ ูู:
1. ุฃูู ููุธู ูุณุงุฑ (isPathOrganizer = true)
2. ุงูุทูุจ ูุนูู ูู (assignedPathOrganizer = userId)
3. ุงูุทูุจ ูู ุญุงูุฉ Accepted

### ุงููุดููุฉ: ูุง ุฃุณุชุทูุน ุงููุตุงุฏูุฉ
**ุงูุญู:** ุชุฃูุฏ ูู:
1. ุงูุทูุจ ูู ุญุงูุฉ Accepted ุฃู InTransit
2. ุฃูุช ูุณุคูู ุนู ุงููุงุนุฉ ุงููุณุชูุฏูุฉ
3. ูุฏูู ุตูุงุญูุฉ CONFIRM_ARRIVAL

---

## ๐ ุงูุฏุนู

ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ:
- **ุนุจุฏุงูุฑุญูู ุงููุงููู**
- **ุนุจุฏุงูุนุฒูุฒ ุงูุฃุญูุฏู**
- **ุนุจุฏุงูุนุฒูุฒ ุงูุฐุจูุงูู**

Made with โค๏ธ in Saudi Arabia - 2026

**B36 System v32 - RBAC Complete** ๐
